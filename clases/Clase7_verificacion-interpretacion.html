<!DOCTYPE html>
<html lang="en"><head>
<script src="Clase7_verificacion-interpretacion_files/libs/clipboard/clipboard.min.js"></script>
<script src="Clase7_verificacion-interpretacion_files/libs/quarto-html/tabby.min.js"></script>
<script src="Clase7_verificacion-interpretacion_files/libs/quarto-html/popper.min.js"></script>
<script src="Clase7_verificacion-interpretacion_files/libs/quarto-html/tippy.umd.min.js"></script>
<link href="Clase7_verificacion-interpretacion_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Clase7_verificacion-interpretacion_files/libs/quarto-html/light-border.css" rel="stylesheet">
<link href="Clase7_verificacion-interpretacion_files/libs/quarto-html/quarto-syntax-highlighting-dark-dc95f10abd972b9c41a78ec8992004fc.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.6.43">

  <title>Verificación e interpretación de modelos</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="Clase7_verificacion-interpretacion_files/libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="Clase7_verificacion-interpretacion_files/libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
      }
    pre.numberSource { margin-left: 3em;  padding-left: 4px; }
    div.sourceCode
      { color: #e1e4e8; background-color: #24292e; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #e1e4e8; } /* Normal */
    code span.al { color: #ff5555; font-weight: bold; } /* Alert */
    code span.an { color: #6a737d; } /* Annotation */
    code span.at { color: #f97583; } /* Attribute */
    code span.bn { color: #79b8ff; } /* BaseN */
    code span.bu { color: #f97583; } /* BuiltIn */
    code span.cf { color: #f97583; } /* ControlFlow */
    code span.ch { color: #9ecbff; } /* Char */
    code span.cn { color: #79b8ff; } /* Constant */
    code span.co { color: #6a737d; } /* Comment */
    code span.cv { color: #6a737d; } /* CommentVar */
    code span.do { color: #6a737d; } /* Documentation */
    code span.dt { color: #f97583; } /* DataType */
    code span.dv { color: #79b8ff; } /* DecVal */
    code span.er { color: #ff5555; text-decoration: underline; } /* Error */
    code span.ex { color: #f97583; font-weight: bold; } /* Extension */
    code span.fl { color: #79b8ff; } /* Float */
    code span.fu { color: #b392f0; } /* Function */
    code span.im { color: #9ecbff; } /* Import */
    code span.in { color: #6a737d; } /* Information */
    code span.kw { color: #f97583; } /* Keyword */
    code span.op { color: #e1e4e8; } /* Operator */
    code span.ot { color: #b392f0; } /* Other */
    code span.pp { color: #f97583; } /* Preprocessor */
    code span.re { color: #6a737d; } /* RegionMarker */
    code span.sc { color: #79b8ff; } /* SpecialChar */
    code span.ss { color: #9ecbff; } /* SpecialString */
    code span.st { color: #9ecbff; } /* String */
    code span.va { color: #ffab70; } /* Variable */
    code span.vs { color: #9ecbff; } /* VerbatimString */
    code span.wa { color: #ff5555; } /* Warning */
  </style>
  <link rel="stylesheet" href="Clase7_verificacion-interpretacion_files/libs/revealjs/dist/theme/quarto-6eb70cf600ae764898b4dd5cd3a36d4f.css">
  <link rel="stylesheet" href="styles.css">
  <link href="Clase7_verificacion-interpretacion_files/libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="Clase7_verificacion-interpretacion_files/libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="Clase7_verificacion-interpretacion_files/libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="Clase7_verificacion-interpretacion_files/libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
</head>
<body class="quarto-dark">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" class="quarto-title-block center">
  <h1 class="title">Verificación e interpretación de modelos</h1>

<div class="quarto-title-authors">
</div>

</section>
<section id="pasos-comunes-en-una-instancia-de-modelado" class="slide level2 scrollable">
<h2>Pasos comunes en una instancia de modelado</h2>
<p><br></p>
<ol type="1">
<li class="fragment">Formulación de modelos cuantitativos a partir de conocimiento previo (definición de previas).<br>
</li>
<li class="fragment">Toma de datos (y pre-procesamiento).</li>
<li class="fragment">Ajuste de modelos a datos (estimación de la posterior).</li>
<li class="fragment">Verificación del algoritmo de estimación (e.g., convergencia del MCMC).</li>
<li class="fragment">Verificación del ajuste del modelo a los datos (e.g., análisis de residuos).</li>
<li class="fragment">Interpretación del modelo (gráficos, predicciones, etc.).</li>
</ol>
</section>
<section id="verificación-de-modelos" class="slide level2">
<h2>Verificación de modelos</h2>
<p><br></p>
<p>Lo mínimo que podemos pedirle a un modelo es que represente de manera razonable los datos con los que fue estimado.</p>
<p><br></p>
<p>En el caso de modelos estadísticos, que son generativos, lo deseable es que puedan simular datos similares a los observados.</p>
</section>
<section class="slide level2">

<h3 id="distribución-predictiva-posterior">Distribución predictiva posterior</h3>
<p><br></p>
<p>Es la distribución de nuevos valores de la variable respuesta, a los que llamaremos <span class="math inline">\(\tilde{y}\)</span>, condicionando en que observamos <span class="math inline">\(y\)</span>.</p>
<p><span class="math display">\[
p(\tilde{y} \mid y) = \int p(\tilde{y} \mid \theta) \ p(\theta \mid y) \ \mathrm{d} \theta.
\]</span></p>
<p>En vez de evaluarla analíticamente, podemos simular de esta distribución utilizando las muestras de <span class="math inline">\(\theta\)</span> que obtuvimos con MCMC.</p>
</section>
<section class="slide level2">

<p>Para cada observación <span class="math inline">\(y_i\)</span> (con <span class="math inline">\(i \in \{1, ..., N\}\)</span>), y con cada muestra de la posterior <span class="math inline">\(\theta_s\)</span> (con <span class="math inline">\(s \in \{1, ..., S\}\)</span>), se simula al menos una observación de la variable respuesta (<span class="math inline">\(\tilde{y}_i^s\)</span>).</p>
<p><br></p>
<p>Si queremos utilizar esta distribución para verificar el modelo, tenemos que simular nuevos datos utilizando los mismos valores de las predictoras (<span class="math inline">\(x\)</span>) asociados a cada observación (<span class="math inline">\(x_i\)</span>).</p>
</section>
<section class="slide level2">

<h3 id="modelo-de-incendios">Modelo de incendios</h3>
<p>Ejemplo con el modelo de la cantidad de incendios por año</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href=""></a><span class="co"># Cargamos datos</span></span>
<span id="cb1-2"><a href=""></a>datos <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"datos"</span>, <span class="st">"barbera_data_fire_total_climate.csv"</span>))</span>
<span id="cb1-3"><a href=""></a></span>
<span id="cb1-4"><a href=""></a><span class="co"># Compilamos el modelo</span></span>
<span id="cb1-5"><a href=""></a>model <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"modelos"</span>, <span class="st">"nfuegos.stan"</span>))</span>
<span id="cb1-6"><a href=""></a></span>
<span id="cb1-7"><a href=""></a><span class="co"># Creamos una lista nombrada para pasarle los datos. Los nombres de cada</span></span>
<span id="cb1-8"><a href=""></a><span class="co"># elemento de la lista tienen que ser exactamente los que definimos en </span></span>
<span id="cb1-9"><a href=""></a><span class="co"># la sección data {}</span></span>
<span id="cb1-10"><a href=""></a>stan_data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1-11"><a href=""></a>  <span class="at">N =</span> <span class="fu">nrow</span>(datos),</span>
<span id="cb1-12"><a href=""></a>  <span class="at">y =</span> datos<span class="sc">$</span>fires,</span>
<span id="cb1-13"><a href=""></a>  <span class="at">x =</span> datos<span class="sc">$</span>fwi</span>
<span id="cb1-14"><a href=""></a>)</span>
<span id="cb1-15"><a href=""></a></span>
<span id="cb1-16"><a href=""></a><span class="co"># Y muestreamos la posterior</span></span>
<span id="cb1-17"><a href=""></a>fit_mcmc <span class="ot">&lt;-</span> model<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb1-18"><a href=""></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb1-19"><a href=""></a>  <span class="at">chains =</span> <span class="dv">4</span>, </span>
<span id="cb1-20"><a href=""></a>  <span class="at">parallel_chains =</span> <span class="dv">4</span>,</span>
<span id="cb1-21"><a href=""></a>  <span class="at">iter_warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb1-22"><a href=""></a>  <span class="at">iter_sampling =</span> <span class="dv">1000</span></span>
<span id="cb1-23"><a href=""></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 1 Iteration:  100 / 2000 [  5%]  (Warmup) 
Chain 1 Iteration:  200 / 2000 [ 10%]  (Warmup) 
Chain 1 Iteration:  300 / 2000 [ 15%]  (Warmup) 
Chain 1 Iteration:  400 / 2000 [ 20%]  (Warmup) 
Chain 1 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 1 Iteration:  600 / 2000 [ 30%]  (Warmup) 
Chain 1 Iteration:  700 / 2000 [ 35%]  (Warmup) 
Chain 1 Iteration:  800 / 2000 [ 40%]  (Warmup) 
Chain 1 Iteration:  900 / 2000 [ 45%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 1100 / 2000 [ 55%]  (Sampling) 
Chain 1 Iteration: 1200 / 2000 [ 60%]  (Sampling) 
Chain 1 Iteration: 1300 / 2000 [ 65%]  (Sampling) 
Chain 1 Iteration: 1400 / 2000 [ 70%]  (Sampling) 
Chain 1 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 1 Iteration: 1600 / 2000 [ 80%]  (Sampling) 
Chain 1 Iteration: 1700 / 2000 [ 85%]  (Sampling) 
Chain 1 Iteration: 1800 / 2000 [ 90%]  (Sampling) 
Chain 1 Iteration: 1900 / 2000 [ 95%]  (Sampling) 
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 2 Iteration:  100 / 2000 [  5%]  (Warmup) 
Chain 2 Iteration:  200 / 2000 [ 10%]  (Warmup) 
Chain 2 Iteration:  300 / 2000 [ 15%]  (Warmup) 
Chain 2 Iteration:  400 / 2000 [ 20%]  (Warmup) 
Chain 2 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 2 Iteration:  600 / 2000 [ 30%]  (Warmup) 
Chain 2 Iteration:  700 / 2000 [ 35%]  (Warmup) 
Chain 2 Iteration:  800 / 2000 [ 40%]  (Warmup) 
Chain 2 Iteration:  900 / 2000 [ 45%]  (Warmup) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 1100 / 2000 [ 55%]  (Sampling) 
Chain 2 Iteration: 1200 / 2000 [ 60%]  (Sampling) 
Chain 2 Iteration: 1300 / 2000 [ 65%]  (Sampling) 
Chain 2 Iteration: 1400 / 2000 [ 70%]  (Sampling) 
Chain 2 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 2 Iteration: 1600 / 2000 [ 80%]  (Sampling) 
Chain 2 Iteration: 1700 / 2000 [ 85%]  (Sampling) 
Chain 2 Iteration: 1800 / 2000 [ 90%]  (Sampling) 
Chain 2 Iteration: 1900 / 2000 [ 95%]  (Sampling) 
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 3 Iteration:  100 / 2000 [  5%]  (Warmup) 
Chain 3 Iteration:  200 / 2000 [ 10%]  (Warmup) 
Chain 3 Iteration:  300 / 2000 [ 15%]  (Warmup) 
Chain 3 Iteration:  400 / 2000 [ 20%]  (Warmup) 
Chain 3 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 3 Iteration:  600 / 2000 [ 30%]  (Warmup) 
Chain 3 Iteration:  700 / 2000 [ 35%]  (Warmup) 
Chain 3 Iteration:  800 / 2000 [ 40%]  (Warmup) 
Chain 3 Iteration:  900 / 2000 [ 45%]  (Warmup) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 1100 / 2000 [ 55%]  (Sampling) 
Chain 3 Iteration: 1200 / 2000 [ 60%]  (Sampling) 
Chain 3 Iteration: 1300 / 2000 [ 65%]  (Sampling) 
Chain 3 Iteration: 1400 / 2000 [ 70%]  (Sampling) 
Chain 3 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 3 Iteration: 1600 / 2000 [ 80%]  (Sampling) 
Chain 3 Iteration: 1700 / 2000 [ 85%]  (Sampling) 
Chain 3 Iteration: 1800 / 2000 [ 90%]  (Sampling) 
Chain 3 Iteration: 1900 / 2000 [ 95%]  (Sampling) 
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 4 Iteration:  100 / 2000 [  5%]  (Warmup) 
Chain 4 Iteration:  200 / 2000 [ 10%]  (Warmup) 
Chain 4 Iteration:  300 / 2000 [ 15%]  (Warmup) 
Chain 4 Iteration:  400 / 2000 [ 20%]  (Warmup) 
Chain 4 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 4 Iteration:  600 / 2000 [ 30%]  (Warmup) 
Chain 4 Iteration:  700 / 2000 [ 35%]  (Warmup) 
Chain 4 Iteration:  800 / 2000 [ 40%]  (Warmup) 
Chain 4 Iteration:  900 / 2000 [ 45%]  (Warmup) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 1100 / 2000 [ 55%]  (Sampling) 
Chain 4 Iteration: 1200 / 2000 [ 60%]  (Sampling) 
Chain 4 Iteration: 1300 / 2000 [ 65%]  (Sampling) 
Chain 4 Iteration: 1400 / 2000 [ 70%]  (Sampling) 
Chain 4 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 4 Iteration: 1600 / 2000 [ 80%]  (Sampling) 
Chain 4 Iteration: 1700 / 2000 [ 85%]  (Sampling) 
Chain 4 Iteration: 1800 / 2000 [ 90%]  (Sampling) 
Chain 4 Iteration: 1900 / 2000 [ 95%]  (Sampling) 
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 0.1 seconds.
Chain 2 finished in 0.1 seconds.
Chain 3 finished in 0.1 seconds.
Chain 4 finished in 0.1 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.1 seconds.
Total execution time: 0.3 seconds.</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href=""></a><span class="co"># Verificamos el HMC </span></span>
<span id="cb3-2"><a href=""></a>fit_mcmc<span class="sc">$</span><span class="fu">cmdstan_diagnose</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Checking sampler transitions treedepth.
Treedepth satisfactory for all transitions.

Checking sampler transitions for divergences.
No divergent transitions found.

Checking E-BFMI - sampler transitions HMC potential energy.
E-BFMI satisfactory.

Rank-normalized split effective sample size satisfactory for all parameters.

Rank-normalized split R-hat values satisfactory for all parameters.

Processing complete, no problems detected.</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href=""></a><span class="co"># Extraemos las muestras de alpha y beta, en formato data.frame</span></span>
<span id="cb5-2"><a href=""></a>d <span class="ot">&lt;-</span> fit_mcmc<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"beta"</span>), <span class="at">format =</span> <span class="st">"draws_df"</span>)</span>
<span id="cb5-3"><a href=""></a><span class="fu">colnames</span>(d) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"b"</span>)</span>
<span id="cb5-4"><a href=""></a></span>
<span id="cb5-5"><a href=""></a><span class="co"># Ahora podemos simular desde la distribución predictiva posterior.</span></span>
<span id="cb5-6"><a href=""></a><span class="co"># Para cada observación simularemos S = 4000 muestras de la predictiva posterior. </span></span>
<span id="cb5-7"><a href=""></a><span class="co"># Guardaremos las simulaciones en una matriz de N * S:</span></span>
<span id="cb5-8"><a href=""></a></span>
<span id="cb5-9"><a href=""></a>S <span class="ot">&lt;-</span> <span class="fu">nrow</span>(d)     <span class="co"># número de muestras de la posterior</span></span>
<span id="cb5-10"><a href=""></a>N <span class="ot">&lt;-</span> <span class="fu">nrow</span>(datos) <span class="co"># número de observaciones</span></span>
<span id="cb5-11"><a href=""></a></span>
<span id="cb5-12"><a href=""></a>ysim <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, N, S)</span>
<span id="cb5-13"><a href=""></a></span>
<span id="cb5-14"><a href=""></a><span class="co"># Simulamos</span></span>
<span id="cb5-15"><a href=""></a><span class="cf">for</span> (s <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>S) {</span>
<span id="cb5-16"><a href=""></a>  <span class="co"># calculamos lambda para la muestra "s"</span></span>
<span id="cb5-17"><a href=""></a>  lambda <span class="ot">&lt;-</span> <span class="fu">exp</span>(d<span class="sc">$</span>a[s] <span class="sc">+</span> d<span class="sc">$</span>b[s] <span class="sc">*</span> datos<span class="sc">$</span>fwi)</span>
<span id="cb5-18"><a href=""></a>  <span class="co"># es un vector de largo N, porque datos$fwi también lo es.</span></span>
<span id="cb5-19"><a href=""></a>  </span>
<span id="cb5-20"><a href=""></a>  <span class="co"># llenamos una columna entera en ysim, que equivale a un set de datos simulado</span></span>
<span id="cb5-21"><a href=""></a>  ysim[, s] <span class="ot">&lt;-</span> <span class="fu">rpois</span>(N, lambda)</span>
<span id="cb5-22"><a href=""></a>}</span>
<span id="cb5-23"><a href=""></a></span>
<span id="cb5-24"><a href=""></a><span class="co"># Ahora cada fila tiene muestras de la distribución predictiva posterior de y </span></span>
<span id="cb5-25"><a href=""></a><span class="co"># para el valor correspondiente de fwi</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section class="slide level2">

<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href=""></a>fila <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span>)</span>
<span id="cb6-2"><a href=""></a></span>
<span id="cb6-3"><a href=""></a>rr <span class="ot">&lt;-</span> <span class="fu">c</span>(datos<span class="sc">$</span>fires[fila], ysim[fila, ]) <span class="sc">|&gt;</span> <span class="fu">range</span>()</span>
<span id="cb6-4"><a href=""></a></span>
<span id="cb6-5"><a href=""></a><span class="fu">hist</span>(ysim[fila, ], <span class="at">xlim =</span> rr, <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"Fila"</span>, fila),</span>
<span id="cb6-6"><a href=""></a>     <span class="at">xlab =</span> <span class="st">"Número de incendios"</span>, <span class="at">ylab =</span> <span class="st">"Frecuencia"</span>)</span>
<span id="cb6-7"><a href=""></a><span class="fu">abline</span>(<span class="at">v =</span> datos<span class="sc">$</span>fires[fila], <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="fl">1.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>

</div>
<img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-2-1.png" width="480" class="r-stretch"></section>
<section class="slide level2">

<p>Una vez obtenida la (muestra de la) distribución predictiva posterior, necesitamos evaluar si nuestros datos parecen salidos de ahí.</p>
<p><br></p>
<p>Para ello utilizamos la Transformación Integral de Probabilidad (<em>PIT</em>, de <em>Probability Integral Transform</em>):</p>
<p><br></p>
<p>sea <span class="math inline">\(Y\)</span> una variable aleatoria continua y <span class="math inline">\(F_Y\)</span> su función de probabilidad acumulada, la variable aleatoria <span class="math inline">\(Z\)</span>, definida como <span class="math inline">\(Z = F_Y(Y)\)</span>, sigue una distribución uniforme entre 0 y 1.</p>
</section>
<section class="slide level2">

<p>Esto implica que si nuestras observaciones se comportan como muestras de la distribución predictiva posterior, sus valores de probabilidad acumulada <em>en conjunto</em> siguen una distribución uniforme entre 0 y 1.</p>
<p><br></p>
<p>A diferencia de los distintos tipos de residuos que suelen calcularse, esto aplica sin importar qué características tenga la distribución predictiva posterior.</p>
<p><br></p>
<p>Sin embargo, esto no se cumple si <span class="math inline">\(Y\)</span> es discreta, y en ese caso hay que aleatorizar los valores de probabilidad acumulada (<span class="math inline">\(Z\)</span>) para que se distribuyan de forma uniforme.</p>
<p><br></p>
<p>Estos valores de probabilidad acumulada (aleatorizados en caso de variables discretas) son calculados por el paquete <code>DHARMa</code> (<em>DHARMa residuals</em>), pero también aparecen en <code>INLA</code>, <code>loo</code> y <code>bayesplot</code> bajo el nombre de <em>PIT values</em>.</p>
</section>
<section class="slide level2">

<p>Ejemplo en <code>R</code></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href=""></a>N <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb7-2"><a href=""></a>y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N)</span>
<span id="cb7-3"><a href=""></a>p <span class="ot">&lt;-</span> <span class="fu">pnorm</span>(y)</span>
<span id="cb7-4"><a href=""></a></span>
<span id="cb7-5"><a href=""></a><span class="fu">hist</span>(p, <span class="at">breaks =</span> <span class="dv">30</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-3-1.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href=""></a><span class="co"># N estadísticos de orden de una uniforme:</span></span>
<span id="cb8-2"><a href=""></a>q_unif <span class="ot">&lt;-</span> <span class="fu">ppoints</span>(N)</span>
<span id="cb8-3"><a href=""></a></span>
<span id="cb8-4"><a href=""></a><span class="fu">plot</span>(<span class="fu">sort</span>(p) <span class="sc">~</span> q_unif, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="fu">rgb</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="fl">0.1</span>),</span>
<span id="cb8-5"><a href=""></a>     <span class="at">ylab =</span> <span class="st">"Cuantiles observados"</span>, <span class="at">xlab =</span> <span class="st">"Cuantiles esperados"</span>)</span>
<span id="cb8-6"><a href=""></a><span class="fu">abline</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-3-2.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href=""></a><span class="co"># ¿Y si las muestras son una mezcla proveniente de distintas distribuciones?</span></span>
<span id="cb9-2"><a href=""></a>y1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N)</span>
<span id="cb9-3"><a href=""></a>y2 <span class="ot">&lt;-</span> <span class="fu">rgamma</span>(N, <span class="dv">1</span>)</span>
<span id="cb9-4"><a href=""></a></span>
<span id="cb9-5"><a href=""></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb9-6"><a href=""></a><span class="fu">plot</span>(<span class="fu">density</span>(y1))</span>
<span id="cb9-7"><a href=""></a><span class="fu">plot</span>(<span class="fu">density</span>(y2, <span class="at">from =</span> <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-3-3.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href=""></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb10-2"><a href=""></a></span>
<span id="cb10-3"><a href=""></a>p1 <span class="ot">&lt;-</span> <span class="fu">pnorm</span>(y1)</span>
<span id="cb10-4"><a href=""></a>p2 <span class="ot">&lt;-</span> <span class="fu">pgamma</span>(y2, <span class="dv">1</span>)</span>
<span id="cb10-5"><a href=""></a></span>
<span id="cb10-6"><a href=""></a>p <span class="ot">&lt;-</span> <span class="fu">c</span>(p1, p2)</span>
<span id="cb10-7"><a href=""></a></span>
<span id="cb10-8"><a href=""></a><span class="fu">hist</span>(p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-3-4.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href=""></a>q_unif <span class="ot">&lt;-</span> <span class="fu">ppoints</span>(N <span class="sc">*</span> <span class="dv">2</span>)</span>
<span id="cb11-2"><a href=""></a><span class="fu">plot</span>(<span class="fu">sort</span>(p) <span class="sc">~</span> q_unif, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="fu">rgb</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="fl">0.1</span>),</span>
<span id="cb11-3"><a href=""></a>     <span class="at">ylab =</span> <span class="st">"Cuantiles observados"</span>, <span class="at">xlab =</span> <span class="st">"Cuantiles esperados"</span>)</span>
<span id="cb11-4"><a href=""></a><span class="fu">abline</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-3-5.png" width="480"></p>
</figure>
</div>
</div>
</div>
</section>
<section class="slide level2">

<p>Ejemplo en <code>R</code> con distribución discreta</p>
<p><br></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href=""></a>y <span class="ot">&lt;-</span> <span class="fu">rpois</span>(N, <span class="dv">10</span>)</span>
<span id="cb12-2"><a href=""></a>freqs <span class="ot">&lt;-</span> <span class="fu">table</span>(y) <span class="sc">/</span> N</span>
<span id="cb12-3"><a href=""></a>vals <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">names</span>(freqs))</span>
<span id="cb12-4"><a href=""></a><span class="fu">barplot</span>(freqs <span class="sc">~</span> vals)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-4-1.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href=""></a>p <span class="ot">&lt;-</span> <span class="fu">ppois</span>(y, <span class="at">lambda =</span> <span class="dv">10</span>)</span>
<span id="cb13-2"><a href=""></a></span>
<span id="cb13-3"><a href=""></a><span class="fu">hist</span>(p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-4-2.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href=""></a>q_unif <span class="ot">&lt;-</span> <span class="fu">ppoints</span>(N)</span>
<span id="cb14-2"><a href=""></a><span class="fu">plot</span>(<span class="fu">sort</span>(p) <span class="sc">~</span> q_unif, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="fu">rgb</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="fl">0.1</span>),</span>
<span id="cb14-3"><a href=""></a>     <span class="at">ylab =</span> <span class="st">"Cuantiles observados"</span>, <span class="at">xlab =</span> <span class="st">"Cuantiles esperados"</span>)</span>
<span id="cb14-4"><a href=""></a><span class="fu">abline</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-4-3.png" width="480"></p>
</figure>
</div>
</div>
</div>
<p>La función de probabilidad acumulada de una discreta es una función escalonada:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href=""></a>vals <span class="ot">&lt;-</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">25</span></span>
<span id="cb15-2"><a href=""></a>p <span class="ot">&lt;-</span> <span class="fu">ppois</span>(vals, <span class="dv">10</span>)</span>
<span id="cb15-3"><a href=""></a><span class="fu">plot</span>(p <span class="sc">~</span> vals, <span class="at">type =</span> <span class="st">"s"</span>)</span>
<span id="cb15-4"><a href=""></a><span class="fu">points</span>(p <span class="sc">~</span> vals, <span class="at">pch =</span> <span class="dv">19</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-5-1.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href=""></a>p <span class="ot">&lt;-</span> <span class="fu">ppois</span>(y, <span class="at">lambda =</span> <span class="dv">10</span>)</span>
<span id="cb16-2"><a href=""></a></span>
<span id="cb16-3"><a href=""></a><span class="fu">hist</span>(p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-5-2.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href=""></a>q_unif <span class="ot">&lt;-</span> <span class="fu">ppoints</span>(N)</span>
<span id="cb17-2"><a href=""></a><span class="fu">plot</span>(<span class="fu">sort</span>(p) <span class="sc">~</span> q_unif, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="fu">rgb</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="fl">0.1</span>),</span>
<span id="cb17-3"><a href=""></a>     <span class="at">ylab =</span> <span class="st">"Cuantiles observados"</span>, <span class="at">xlab =</span> <span class="st">"Cuantiles esperados"</span>)</span>
<span id="cb17-4"><a href=""></a><span class="fu">abline</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-5-3.png" width="480"></p>
</figure>
</div>
</div>
</div>
</section>
<section class="slide level2">

<p>Para transformar estos valores de probabilidad acumulada en una variable con distribución uniforme, construimos nuestro valor <span class="math inline">\(Z\)</span> (PIT) de la siguiente manera: <span class="math display">\[Z_i \sim \text{uniforme}(F_Y(y_i- 1), F_Y(y_i)).\]</span></p>
<p>Es decir, en vez de quedarnos con la probabilidad acumulada (<span class="math inline">\(F_Y(y_i)\)</span>), tomamos una muestra de una distribución uniforme limitada entre ese valor (por arriba) y la probabilidad acumulada de <span class="math inline">\(y_i - 1\)</span> (<span class="math inline">\(F_Y(y_i- 1)\)</span>).</p>
</section>
<section class="slide level2">

<p>PIT para variable discreta</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href=""></a>y <span class="ot">&lt;-</span> <span class="fu">rpois</span>(N, <span class="dv">10</span>)</span>
<span id="cb18-2"><a href=""></a>freqs <span class="ot">&lt;-</span> <span class="fu">table</span>(y) <span class="sc">/</span> N</span>
<span id="cb18-3"><a href=""></a>vals <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">names</span>(freqs))</span>
<span id="cb18-4"><a href=""></a><span class="fu">barplot</span>(freqs <span class="sc">~</span> vals)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-6-1.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href=""></a>p <span class="ot">&lt;-</span> <span class="fu">ppois</span>(y, <span class="at">lambda =</span> <span class="dv">10</span>) <span class="co"># Probabilidad acumulada en y</span></span>
<span id="cb19-2"><a href=""></a>pl1 <span class="ot">&lt;-</span> <span class="fu">ppois</span>(y<span class="dv">-1</span>, <span class="at">lambda =</span> <span class="dv">10</span>) <span class="co"># Probabilidad acumulada en y-1</span></span>
<span id="cb19-3"><a href=""></a>pit <span class="ot">&lt;-</span> <span class="fu">runif</span>(N, pl1, p)</span>
<span id="cb19-4"><a href=""></a></span>
<span id="cb19-5"><a href=""></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb19-6"><a href=""></a><span class="fu">hist</span>(p, <span class="at">breaks =</span> <span class="dv">20</span>, <span class="at">main =</span> <span class="cn">NA</span>, <span class="at">xlab =</span> <span class="st">"Probabilidad acumulada"</span>)</span>
<span id="cb19-7"><a href=""></a><span class="fu">hist</span>(pit, <span class="at">breaks =</span> <span class="dv">20</span>, <span class="at">main =</span> <span class="cn">NA</span>, <span class="at">xlab =</span> <span class="st">"Probabilidad acumulada</span><span class="sc">\n</span><span class="st">aleatorizada"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-6-2.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href=""></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb20-2"><a href=""></a></span>
<span id="cb20-3"><a href=""></a>q_unif <span class="ot">&lt;-</span> <span class="fu">ppoints</span>(N)</span>
<span id="cb20-4"><a href=""></a></span>
<span id="cb20-5"><a href=""></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb20-6"><a href=""></a><span class="fu">plot</span>(<span class="fu">sort</span>(p) <span class="sc">~</span> q_unif, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="fu">rgb</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="fl">0.1</span>),</span>
<span id="cb20-7"><a href=""></a>     <span class="at">ylab =</span> <span class="st">"Cuantiles observados"</span>, <span class="at">xlab =</span> <span class="st">"Cuantiles esperados"</span>,</span>
<span id="cb20-8"><a href=""></a>     <span class="at">main =</span> <span class="st">"Probabilidad acumulada"</span>)</span>
<span id="cb20-9"><a href=""></a><span class="fu">abline</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb20-10"><a href=""></a></span>
<span id="cb20-11"><a href=""></a><span class="fu">plot</span>(<span class="fu">sort</span>(pit) <span class="sc">~</span> q_unif, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="fu">rgb</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="fl">0.1</span>),</span>
<span id="cb20-12"><a href=""></a>     <span class="at">ylab =</span> <span class="st">"Cuantiles observados"</span>, <span class="at">xlab =</span> <span class="st">"Cuantiles esperados"</span>,</span>
<span id="cb20-13"><a href=""></a>     <span class="at">main =</span> <span class="st">"Probabilidad acumulada</span><span class="sc">\n</span><span class="st">aleatorizada"</span>)</span>
<span id="cb20-14"><a href=""></a><span class="fu">abline</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">col =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-6-3.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href=""></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section class="slide level2">

<p>Cuando evaluamos ajustes bayesianos, la distribución estimada por el modelo generalmente varía entre observaciones (sigue la misma estructura, e.g., poisson, pero tiene otros parámetros). En general aproximamos la acumulada mediante la función de probabilidad acumulada empírica (en <code>R</code>, la función <code>ecdf</code>).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href=""></a>N <span class="ot">&lt;-</span> <span class="fu">nrow</span>(datos)</span>
<span id="cb22-2"><a href=""></a>fila <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span>)</span>
<span id="cb22-3"><a href=""></a></span>
<span id="cb22-4"><a href=""></a><span class="co"># Obtenemos la función de distribución acumulada empírica de la distribución </span></span>
<span id="cb22-5"><a href=""></a><span class="co"># predictiva posterior para la fila elegida</span></span>
<span id="cb22-6"><a href=""></a>ecdf_post <span class="ot">&lt;-</span> <span class="fu">ecdf</span>(ysim[fila, ])</span>
<span id="cb22-7"><a href=""></a></span>
<span id="cb22-8"><a href=""></a><span class="co"># al evaluarla, en el valor observado nos devuelve la probabilidad acumulada</span></span>
<span id="cb22-9"><a href=""></a>(prob <span class="ot">&lt;-</span> <span class="fu">ecdf_post</span>(datos<span class="sc">$</span>fires[fila]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.806</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href=""></a><span class="co"># Calculamos el PIT:</span></span>
<span id="cb24-2"><a href=""></a>(pit <span class="ot">&lt;-</span> <span class="fu">runif</span>(</span>
<span id="cb24-3"><a href=""></a>  <span class="dv">1</span>, </span>
<span id="cb24-4"><a href=""></a>  <span class="at">min =</span> <span class="fu">ecdf_post</span>(datos<span class="sc">$</span>fires[fila] <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb24-5"><a href=""></a>  <span class="at">max =</span> <span class="fu">ecdf_post</span>(datos<span class="sc">$</span>fires[fila])</span>
<span id="cb24-6"><a href=""></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7215815</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href=""></a>rr <span class="ot">&lt;-</span> <span class="fu">c</span>(datos<span class="sc">$</span>fires[fila], ysim[fila, ]) <span class="sc">|&gt;</span> <span class="fu">range</span>()</span>
<span id="cb26-2"><a href=""></a></span>
<span id="cb26-3"><a href=""></a><span class="co"># Título</span></span>
<span id="cb26-4"><a href=""></a>tt <span class="ot">&lt;-</span> <span class="fu">paste</span>(</span>
<span id="cb26-5"><a href=""></a>  <span class="st">"Fila "</span>, fila, <span class="st">"; Prob = "</span>, </span>
<span id="cb26-6"><a href=""></a>  <span class="fu">round</span>(prob, <span class="dv">3</span>), </span>
<span id="cb26-7"><a href=""></a>  <span class="st">"; PIT = "</span>, </span>
<span id="cb26-8"><a href=""></a>  <span class="fu">round</span>(pit, <span class="dv">3</span>), </span>
<span id="cb26-9"><a href=""></a>  <span class="at">sep =</span> <span class="st">""</span></span>
<span id="cb26-10"><a href=""></a>)</span>
<span id="cb26-11"><a href=""></a><span class="fu">hist</span>(ysim[fila, ], <span class="at">xlim =</span> rr, <span class="at">main =</span> tt,</span>
<span id="cb26-12"><a href=""></a>     <span class="at">xlab =</span> <span class="st">"Número de incendios"</span>, <span class="at">ylab =</span> <span class="st">"Frecuencia"</span>)</span>
<span id="cb26-13"><a href=""></a><span class="fu">abline</span>(<span class="at">v =</span> datos<span class="sc">$</span>fires[fila], <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="fl">1.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>

</div>
<img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-7-1.png" width="480" class="r-stretch"></section>
<section class="slide level2">

<p>Pero <code>DHARMa</code> calcula los PIT por nosotros; sólo necesitamos darle una matriz de datos simulados.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href=""></a>res <span class="ot">&lt;-</span> <span class="fu">createDHARMa</span>(</span>
<span id="cb27-2"><a href=""></a>  <span class="at">simulatedResponse =</span> ysim,</span>
<span id="cb27-3"><a href=""></a>  <span class="at">observedResponse =</span> datos<span class="sc">$</span>fires,</span>
<span id="cb27-4"><a href=""></a>  <span class="at">integerResponse =</span> <span class="cn">TRUE</span> <span class="co"># se da cuenta solo, pero por las dudas</span></span>
<span id="cb27-5"><a href=""></a>)</span>
<span id="cb27-6"><a href=""></a></span>
<span id="cb27-7"><a href=""></a><span class="fu">plot</span>(res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-8-1.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href=""></a><span class="fu">hist</span>(res<span class="sc">$</span>scaledResiduals)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-8-2.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href=""></a><span class="co"># Podemos ver si hay alguna tendencia en función de una predictora</span></span>
<span id="cb29-2"><a href=""></a><span class="fu">plotResiduals</span>(res, <span class="at">form =</span> datos<span class="sc">$</span>fwi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-8-3.png" width="480"></p>
</figure>
</div>
</div>
</div>
<p>El modelo admite menor variabilidad que la encontrada en los datos.</p>
</section>
<section class="slide level2">

<p>Este modelo debe ser mejorado, pero podemos usar los residuos para ver si nos falta agregar alguna variable importante:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href=""></a><span class="co"># Agregamos los PIT calculados por DHARMa a la tabla de datos</span></span>
<span id="cb30-2"><a href=""></a>datos<span class="sc">$</span>pit <span class="ot">&lt;-</span> res<span class="sc">$</span>scaledResiduals</span>
<span id="cb30-3"><a href=""></a></span>
<span id="cb30-4"><a href=""></a><span class="fu">ggplot</span>(datos, <span class="fu">aes</span>(pp, pit)) <span class="sc">+</span></span>
<span id="cb30-5"><a href=""></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb30-6"><a href=""></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Prob. acumulada"</span>,  <span class="co"># o "residuos dharma"</span></span>
<span id="cb30-7"><a href=""></a>       <span class="at">x =</span> <span class="st">"Precipitación (mm)"</span>) <span class="sc">+</span></span>
<span id="cb30-8"><a href=""></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"gam"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>

<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href=""></a><span class="co"># No parece haber una tendencia, lo cual sugiere que no ganaríamos mucho </span></span>
<span id="cb31-2"><a href=""></a><span class="co"># incluyendo la precipitación.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-9-1.png" width="480" class="r-stretch"></section>
<section class="slide level2">

<p>Esa es la forma más robusta de comparar la predictiva posterior con los datos, pero también podemos usar al paquete <code>bayesplot</code>, de nuestros amigos de <code>Stan</code>, para visualizar el ajuste de otras formas.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href=""></a><span class="co"># Trasponemos la matriz de datos simulados porque a bayesplot le gustan las </span></span>
<span id="cb32-2"><a href=""></a><span class="co"># iteraciones de la posterior como filas (las teníamos en las columnas)</span></span>
<span id="cb32-3"><a href=""></a>ysim_t <span class="ot">&lt;-</span> <span class="fu">t</span>(ysim)</span>
<span id="cb32-4"><a href=""></a></span>
<span id="cb32-5"><a href=""></a><span class="co"># posterior predictive intervals en función de algo</span></span>
<span id="cb32-6"><a href=""></a><span class="fu">ppc_intervals</span>(</span>
<span id="cb32-7"><a href=""></a>  <span class="at">y =</span> datos<span class="sc">$</span>fires, <span class="co"># observaciones</span></span>
<span id="cb32-8"><a href=""></a>  <span class="at">yrep =</span> ysim_t,   <span class="co"># simulaciones de la predictiva posterior</span></span>
<span id="cb32-9"><a href=""></a>  <span class="at">x =</span> datos<span class="sc">$</span>fwi,   <span class="co"># alguna predictora de interés</span></span>
<span id="cb32-10"><a href=""></a>  <span class="at">prob =</span> <span class="fl">0.9</span>       <span class="co"># probabilidad de los intervalos</span></span>
<span id="cb32-11"><a href=""></a>) <span class="sc">+</span></span>
<span id="cb32-12"><a href=""></a><span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"FWI"</span>, <span class="at">y =</span> <span class="st">"Número de incendios"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-10-1.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href=""></a><span class="co"># Y la densidad marginal de la respuesta, según lo observado (y) y los sets de </span></span>
<span id="cb33-2"><a href=""></a><span class="co"># datos simulados (yrep). Como graficará una curva por set de datos simulado, </span></span>
<span id="cb33-3"><a href=""></a><span class="co"># será mejor elegir al azar unos pocos (menos que 4000)</span></span>
<span id="cb33-4"><a href=""></a>use <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>S, <span class="dv">100</span>) <span class="co"># elige 100 al azar</span></span>
<span id="cb33-5"><a href=""></a><span class="fu">ppc_dens_overlay</span>(<span class="at">y =</span> datos<span class="sc">$</span>fires, <span class="at">yrep =</span> ysim_t[use, ])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-10-2.png" width="480"></p>
</figure>
</div>
</div>
</div>
</section>
<section class="slide level2">

<p>Con estas herramientas podemos evaluar dónde falla el modelo y así intentar mejorarlo.</p>
<p><br></p>
<p>Cuánto hay que mejorarlo, depende del contexto.</p>
</section>
<section id="interpretación-de-modelos" class="slide level2">
<h2>Interpretación de modelos</h2>
<p><br></p>
<p>Si el modelo se adecúa razonablemente a los datos, podemos comenzar a evaluar qué implica la posterior estimada. (Aunque a veces, visualizar el ajuste también puede ayudar a identificar potenciales problemas.)</p>
<p><br></p>
<p>En algunos casos los parámetros en sí resultan de interés, pero en otros casos, sólo nos interesan cantidades derivadas de ellos.</p>
</section>
<section class="slide level2">

<p>Ejemplo: nos interesa evaluar cómo varía <span class="math inline">\(\lambda\)</span> en función del FWI.</p>
<p><br></p>
<p>Cada muestra <span class="math inline">\(s\)</span> de la posterior (<span class="math inline">\(\{\alpha_s, \beta_s\}\)</span>) define una función <span class="math display">\[\lambda_s = f_s(\text{FWI}) = \exp(\alpha_s + \beta_s \ \text{FWI}).\]</span></p>
<p><br></p>
<p>Si nos interesa describir esa función considerando la incertidumbre en la estimación, podemos evaluarla sobre una secuencia de <span class="math inline">\(\text{FWI}\)</span> utilizando todas o algunas muestras de la posterior.</p>
<p><br></p>
<p>Importante: si guardamos las muestras en una matriz, donde cada fila es una iteración, no podemos mezclar valores de distintas filas. Esto es porque estaríamos rompiendo la estructura de correlaciones de la posterior conjunta.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href=""></a>nrep <span class="ot">&lt;-</span> <span class="dv">200</span> <span class="co"># largo de la secuencia de FWI</span></span>
<span id="cb34-2"><a href=""></a>fwi_seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(datos<span class="sc">$</span>fwi), <span class="fu">max</span>(datos<span class="sc">$</span>fwi), <span class="at">length.out =</span> nrep)</span>
<span id="cb34-3"><a href=""></a></span>
<span id="cb34-4"><a href=""></a><span class="co"># Guardaremos la función evaluada sobre la secuencia de fwi en una matriz, </span></span>
<span id="cb34-5"><a href=""></a><span class="co"># donde cada columna corresponderá a una muestra de la posterior</span></span>
<span id="cb34-6"><a href=""></a>lambda_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, nrep, S)</span>
<span id="cb34-7"><a href=""></a></span>
<span id="cb34-8"><a href=""></a><span class="cf">for</span> (s <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>S) {</span>
<span id="cb34-9"><a href=""></a>  lambda_mat[, s] <span class="ot">&lt;-</span> <span class="fu">exp</span>(d<span class="sc">$</span>a[s] <span class="sc">+</span> d<span class="sc">$</span>b[s] <span class="sc">*</span> fwi_seq)</span>
<span id="cb34-10"><a href=""></a>}</span>
<span id="cb34-11"><a href=""></a></span>
<span id="cb34-12"><a href=""></a><span class="co"># Podemos graficar algunas curvas ("spaghetti plot").</span></span>
<span id="cb34-13"><a href=""></a><span class="co"># Ordenaremos la matriz para graficarla con ggplot</span></span>
<span id="cb34-14"><a href=""></a>ncurves <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb34-15"><a href=""></a>use <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>S, ncurves) <span class="co"># elegimos 150 curvas al azar</span></span>
<span id="cb34-16"><a href=""></a>lambda_mat_sub <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(lambda_mat[, use]) </span>
<span id="cb34-17"><a href=""></a>lambda_mat_sub<span class="sc">$</span>fwi <span class="ot">&lt;-</span> fwi_seq</span>
<span id="cb34-18"><a href=""></a></span>
<span id="cb34-19"><a href=""></a><span class="co"># Elongamos la matriz</span></span>
<span id="cb34-20"><a href=""></a>llong <span class="ot">&lt;-</span> <span class="fu">pivot_longer</span>(</span>
<span id="cb34-21"><a href=""></a>  lambda_mat_sub, <span class="at">cols =</span> <span class="fu">all_of</span>(<span class="dv">1</span><span class="sc">:</span>ncurves), </span>
<span id="cb34-22"><a href=""></a>  <span class="at">names_to =</span> <span class="st">"sim"</span>, <span class="at">values_to =</span> <span class="st">"lambda"</span></span>
<span id="cb34-23"><a href=""></a>)</span>
<span id="cb34-24"><a href=""></a></span>
<span id="cb34-25"><a href=""></a><span class="fu">ggplot</span>(llong, <span class="fu">aes</span>(fwi, lambda, <span class="at">group =</span> sim)) <span class="sc">+</span></span>
<span id="cb34-26"><a href=""></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb34-27"><a href=""></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"FWI"</span>, <span class="at">y =</span> <span class="fu">expression</span>(lambda))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-11-1.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href=""></a><span class="co"># Lambda es una cantidad derivada de alpha, beta y el fwi. Todo lo que se calcula</span></span>
<span id="cb35-2"><a href=""></a><span class="co"># a partir de los parámetros tiene su propia distribución posterior. Y acá </span></span>
<span id="cb35-3"><a href=""></a><span class="co"># tenemos, además, una distribución posterior de lambda para cada valor de </span></span>
<span id="cb35-4"><a href=""></a><span class="co"># fwi que evaluemos.</span></span>
<span id="cb35-5"><a href=""></a></span>
<span id="cb35-6"><a href=""></a><span class="co"># Otra forma de graficar la función es resumir la distribución de cada lambda,</span></span>
<span id="cb35-7"><a href=""></a><span class="co"># es decir, la distribución de lambda marginal a alpha y beta para cada x.</span></span>
<span id="cb35-8"><a href=""></a></span>
<span id="cb35-9"><a href=""></a>pred <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb35-10"><a href=""></a>  <span class="at">fwi =</span> fwi_seq,</span>
<span id="cb35-11"><a href=""></a>  <span class="at">lambda_mean =</span> <span class="fu">rowMeans</span>(lambda_mat),</span>
<span id="cb35-12"><a href=""></a>  <span class="at">lambda_lwr =</span> <span class="fu">apply</span>(lambda_mat, <span class="dv">1</span>, quantile, <span class="at">probs =</span> <span class="fl">0.025</span>),</span>
<span id="cb35-13"><a href=""></a>  <span class="at">lambda_upr =</span> <span class="fu">apply</span>(lambda_mat, <span class="dv">1</span>, quantile, <span class="at">probs =</span> <span class="fl">0.975</span>)</span>
<span id="cb35-14"><a href=""></a>)</span>
<span id="cb35-15"><a href=""></a></span>
<span id="cb35-16"><a href=""></a><span class="co"># apply() es una forma concisa de loopear. equivale a hacer</span></span>
<span id="cb35-17"><a href=""></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb35-18"><a href=""></a>  pred<span class="sc">$</span>lambda_lwr[i] <span class="ot">&lt;-</span> <span class="fu">quantile</span>(lambda_mat[i, ], <span class="at">probs =</span> <span class="fl">0.025</span>)</span>
<span id="cb35-19"><a href=""></a>}</span>
<span id="cb35-20"><a href=""></a><span class="co"># Es decir, aplica la función quantile, con argumento probs = 0.025, sobre el </span></span>
<span id="cb35-21"><a href=""></a><span class="co"># array llamado "lambda_mat", iterando sobre la dimensión 1 (filas)</span></span>
<span id="cb35-22"><a href=""></a> </span>
<span id="cb35-23"><a href=""></a><span class="co"># Ahora graficamos la predicción media y su incertidumbre</span></span>
<span id="cb35-24"><a href=""></a><span class="fu">ggplot</span>(pred, <span class="fu">aes</span>(fwi, lambda_mean, <span class="at">ymin =</span> lambda_lwr, <span class="at">ymax =</span> lambda_upr)) <span class="sc">+</span></span>
<span id="cb35-25"><a href=""></a>  <span class="fu">geom_ribbon</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">fill =</span> <span class="st">"orange"</span>) <span class="sc">+</span></span>
<span id="cb35-26"><a href=""></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb35-27"><a href=""></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"FWI"</span>, <span class="at">y =</span> <span class="fu">expression</span>(lambda)) <span class="sc">+</span></span>
<span id="cb35-28"><a href=""></a>  <span class="co"># Agregamos los datos</span></span>
<span id="cb35-29"><a href=""></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(fwi, fires), <span class="at">data =</span> datos, <span class="at">inherit.aes =</span> F,</span>
<span id="cb35-30"><a href=""></a>             <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">size =</span> <span class="dv">2</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-11-2.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href=""></a><span class="co"># La cinta muestra los percentiles 2.5 y 97.5 % de la distribución posterior de</span></span>
<span id="cb36-2"><a href=""></a><span class="co"># lambda. Pero también podemos explorar los percentiles extremos de la</span></span>
<span id="cb36-3"><a href=""></a><span class="co"># distribución predictiva posterior de y.</span></span>
<span id="cb36-4"><a href=""></a><span class="co"># Para eso, simulamos nuevas observaciones sobre la secuencia de FWI.</span></span>
<span id="cb36-5"><a href=""></a><span class="co"># (Antes, para el chequeo posterior, habíamos simulado nuevos valores de y</span></span>
<span id="cb36-6"><a href=""></a><span class="co"># usando los valores observados de FWI, no sobre una secuencia.)</span></span>
<span id="cb36-7"><a href=""></a></span>
<span id="cb36-8"><a href=""></a>ysim_seq <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, nrep, S)</span>
<span id="cb36-9"><a href=""></a><span class="cf">for</span> (s <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>S) {</span>
<span id="cb36-10"><a href=""></a>  ysim_seq[, s] <span class="ot">&lt;-</span> <span class="fu">rpois</span>(nrep, <span class="at">lambda =</span> lambda_mat[, s])</span>
<span id="cb36-11"><a href=""></a>}</span>
<span id="cb36-12"><a href=""></a></span>
<span id="cb36-13"><a href=""></a><span class="co"># Obtenemos los cuantiles extremos:</span></span>
<span id="cb36-14"><a href=""></a>pred<span class="sc">$</span>y_lwr <span class="ot">&lt;-</span> <span class="fu">apply</span>(ysim_seq, <span class="dv">1</span>, quantile, <span class="at">probs =</span> <span class="fl">0.025</span>)</span>
<span id="cb36-15"><a href=""></a>pred<span class="sc">$</span>y_upr <span class="ot">&lt;-</span> <span class="fu">apply</span>(ysim_seq, <span class="dv">1</span>, quantile, <span class="at">probs =</span> <span class="fl">0.975</span>)</span>
<span id="cb36-16"><a href=""></a></span>
<span id="cb36-17"><a href=""></a><span class="co"># Ahora graficamos la predicción media y su incertidumbre</span></span>
<span id="cb36-18"><a href=""></a><span class="fu">ggplot</span>(pred, <span class="fu">aes</span>(fwi, lambda_mean, <span class="at">ymin =</span> lambda_lwr, <span class="at">ymax =</span> lambda_upr)) <span class="sc">+</span></span>
<span id="cb36-19"><a href=""></a>  <span class="co"># Intervalo para y</span></span>
<span id="cb36-20"><a href=""></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(fwi, <span class="at">ymin =</span> y_lwr, <span class="at">ymax =</span> y_upr), <span class="at">inherit.aes =</span> F, </span>
<span id="cb36-21"><a href=""></a>              <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">fill =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb36-22"><a href=""></a>  <span class="co"># Intervalo para lambda</span></span>
<span id="cb36-23"><a href=""></a>  <span class="fu">geom_ribbon</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">fill =</span> <span class="st">"orange"</span>) <span class="sc">+</span></span>
<span id="cb36-24"><a href=""></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb36-25"><a href=""></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"FWI"</span>, <span class="at">y =</span> <span class="fu">expression</span>(lambda)) <span class="sc">+</span></span>
<span id="cb36-26"><a href=""></a>  <span class="co"># Agregamos los datos</span></span>
<span id="cb36-27"><a href=""></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(fwi, fires), <span class="at">data =</span> datos, <span class="at">inherit.aes =</span> F,</span>
<span id="cb36-28"><a href=""></a>             <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">size =</span> <span class="dv">2</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-11-3.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href=""></a><span class="co"># La cinta más ancha es donde esperamos ver los datos con 95 % de probabilidad;</span></span>
<span id="cb37-2"><a href=""></a><span class="co"># la cinta más fina es donde esperamos ver la media de muchos datos, con 95 % </span></span>
<span id="cb37-3"><a href=""></a><span class="co"># de probabilidad.</span></span>
<span id="cb37-4"><a href=""></a><span class="co"># El más ancho se suele llamar intervalo de predicción; el más fino, intervalo de </span></span>
<span id="cb37-5"><a href=""></a><span class="co"># credibilidad para la media.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section class="slide level2">

<h3 id="r2-bayesiano-gelman-et-al.-2019"><span class="math inline">\(R^2\)</span> bayesiano (Gelman et al.&nbsp;2019)</h3>
<p><br></p>
<p>El coeficiente de determinación bayesiano se define así:</p>
<p><span class="math display">\[
R^2 = \frac{\text{varianza de los predichos}}{\text{varianza de los predichos} + \text{varianza residual}},
\]</span></p>
<p>donde los predichos son la esperanza (media) predicha para cada observación. La varianza de los predichos se toma a lo largo de las observaciones (<span class="math inline">\(N\)</span> predichos). La varianza residual es la varianza <em>estimada</em> para cada observación. La varianza residual se promedia entre las <span class="math inline">\(N\)</span> observaciones.</p>
<p>Representa la proporción de la variabilidad en la distribución estimada de los datos que es explicada por el modelo.</p>
</section>
<section class="slide level2">

<h3 id="r2-a-partir-de-muestras-de-la-posterior"><span class="math inline">\(R^2\)</span> a partir de muestras de la posterior</h3>
<p><br></p>
<p>Con una estimación bayesiana basada en muestras de la posterior <span class="math inline">\(s \in \{1, \dots, S\}\)</span>, el <span class="math inline">\(R^2\)</span> se puede calcular para cada muestra:</p>
<p><span class="math display">\[
R_s^2 = \frac{\mathrm{Var}(\boldsymbol{\mu_s})}{\mathrm{Var}(\boldsymbol{\mu_s}) + \frac{1}{N} \sum(\boldsymbol{\tau}_s)},
\]</span></p>
<p>donde <span class="math inline">\(\boldsymbol{\mu}_s\)</span> es el vector de largo <span class="math inline">\(N\)</span> con la esperanza estimada para cada observación, calculada con el vector de parámetros <span class="math inline">\(\boldsymbol{\theta}_s\)</span>. <span class="math inline">\(\boldsymbol{\tau}_s\)</span> es el vector de varianzas estimadas para cada observación, también basado en <span class="math inline">\(\boldsymbol{\theta}_s\)</span>. En el caso de un modelo normal, sería un vector de <span class="math inline">\(\sigma^2\)</span>. (Nótese que en la mayor parte de las distribuciones la varianza varía con la media, por lo que suele variar entre observaciones.)</p>
<p>Estimando <span class="math inline">\(R_s^2\)</span> para cada <span class="math inline">\(s\)</span>, obtenemos su distribución posterior.</p>
</section>
<section class="slide level2">

<p>Importante: dado que el <span class="math inline">\(R^2\)</span> bayesiano está basado en la varianza y media estimadas, para que sea confiable, el modelo debe representar los datos de forma adecuada. Por ejemplo, un modelo que subestima la variabilidad en los datos va a sobreestimar el <span class="math inline">\(R^2\)</span>. Por eso es importante verificar el modelo con residuos DHARMa y hacer lo posible por que cuantifique de forma razonable la variabilidad.</p>
</section>
<section class="slide level2">

<p><span class="math inline">\(R^2\)</span> para el modelo de incendios.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href=""></a><span class="co"># Vector para almacenar el R2</span></span>
<span id="cb38-2"><a href=""></a>R2 <span class="ot">&lt;-</span> <span class="fu">numeric</span>(S)</span>
<span id="cb38-3"><a href=""></a></span>
<span id="cb38-4"><a href=""></a><span class="co"># Loop sobre muestras de la posterior</span></span>
<span id="cb38-5"><a href=""></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>S) {</span>
<span id="cb38-6"><a href=""></a>  <span class="co"># predichos para cada observación</span></span>
<span id="cb38-7"><a href=""></a>  mu <span class="ot">&lt;-</span> <span class="fu">exp</span>(d<span class="sc">$</span>a[i] <span class="sc">+</span> d<span class="sc">$</span>b[i] <span class="sc">*</span> datos<span class="sc">$</span>fwi) <span class="co"># es lambda!</span></span>
<span id="cb38-8"><a href=""></a>  </span>
<span id="cb38-9"><a href=""></a>  <span class="co"># varianza de los predichos = varianza explicada</span></span>
<span id="cb38-10"><a href=""></a>  var_fit <span class="ot">&lt;-</span> <span class="fu">var</span>(mu)</span>
<span id="cb38-11"><a href=""></a>  </span>
<span id="cb38-12"><a href=""></a>  <span class="co"># varianza residual para cada observación. Esto depende de la </span></span>
<span id="cb38-13"><a href=""></a>  <span class="co"># distribución. En la poisson, la varianza es igual al media</span></span>
<span id="cb38-14"><a href=""></a>  var_res <span class="ot">&lt;-</span> mu <span class="co"># sólo para ser explícitos</span></span>
<span id="cb38-15"><a href=""></a>  <span class="co"># y tomamos su media entre observaciones</span></span>
<span id="cb38-16"><a href=""></a>  var_res_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(var_res)</span>
<span id="cb38-17"><a href=""></a>  </span>
<span id="cb38-18"><a href=""></a>  <span class="co"># R2 </span></span>
<span id="cb38-19"><a href=""></a>  R2[i] <span class="ot">&lt;-</span> var_fit <span class="sc">/</span> (var_fit <span class="sc">+</span> var_res_mean)</span>
<span id="cb38-20"><a href=""></a>}</span>
<span id="cb38-21"><a href=""></a></span>
<span id="cb38-22"><a href=""></a><span class="fu">plot</span>(<span class="fu">density</span>(R2, <span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">1</span>), <span class="at">main =</span> <span class="cn">NA</span>, <span class="at">xlab =</span> <span class="st">"R2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>

</div>
<img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-12-1.png" width="480" class="r-stretch"><p>El <span class="math inline">\(R^2\)</span> da alto, pero hay que considerar que el modelo subestima la variabilidad en los datos (variabilidad no explicada). Si modeláramos con una binomial negativa, que admite más variabilidad que una poisson, el <span class="math inline">\(R^2\)</span> sería notablemente más bajo.</p>
</section>
<section class="slide level2">

<p>Formulación del <span class="math inline">\(R^2\)</span> bayesiano:</p>
<p>Gelman, A., Goodrich, B., Gabry, J., &amp; Vehtari, A. (2019). R-squared for Bayesian regression models. The American Statistician.</p>
</section>
<section class="slide level2">

<h3 id="modelo-de-germinación-más-de-una-predictora">Modelo de germinación (más de una predictora)</h3>
<p>[Datos de Alinari et al.&nbsp;2023]</p>
<p><span class="math display">\[
\begin{aligned}
y_i &amp;\sim \text{beta-binomial}(\mu_i, \phi, S_i) \\
\mu_i &amp;= \frac{1}{1 + \exp(-\eta_i)} \\
\eta_i &amp;= \alpha + \beta_D \ D_i + \beta_E \ E_i + \beta_H \ H_i\\
\\
\alpha &amp;\sim \text{normal}(0, 10) \\
\beta_. &amp;\sim \text{normal}(0, 5) \\
\phi &amp;\sim \text{log-normal}(\log(7), 1.5) \\
\\
\text{y: } &amp;\text{Número de semillas germinadas} \\
\text{N: } &amp;\text{Número de semillas sembradas} \\
\text{D: } &amp;\text{Daño por fuego} \\
\text{E: } &amp;\text{Altidud} \\
\text{H: } &amp;\text{Altura inicial del árbol} \\
\end{aligned}
\]</span></p>
</section>
<section class="slide level2">

<p>Ajustamos el modelo</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href=""></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>()) <span class="co"># Limpiamos el entorno</span></span>
<span id="cb39-2"><a href=""></a></span>
<span id="cb39-3"><a href=""></a><span class="co"># Cargamos datos</span></span>
<span id="cb39-4"><a href=""></a>datos <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"datos"</span>, <span class="st">"alinari_data_espinillo.csv"</span>))</span>
<span id="cb39-5"><a href=""></a></span>
<span id="cb39-6"><a href=""></a><span class="co"># Conservamos los que tienen datos de germinación</span></span>
<span id="cb39-7"><a href=""></a>datos <span class="ot">&lt;-</span> <span class="fu">subset</span>(datos, <span class="sc">!</span><span class="fu">is.na</span>(germinadas) <span class="sc">&amp;</span> sembradas <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb39-8"><a href=""></a></span>
<span id="cb39-9"><a href=""></a><span class="co"># Estandarizamos las predictoras para tener efectos comparables y para </span></span>
<span id="cb39-10"><a href=""></a><span class="co"># facilitar la interpretación de las previas</span></span>
<span id="cb39-11"><a href=""></a>D_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(datos<span class="sc">$</span>danio)</span>
<span id="cb39-12"><a href=""></a>D_sd <span class="ot">&lt;-</span> <span class="fu">sd</span>(datos<span class="sc">$</span>danio)</span>
<span id="cb39-13"><a href=""></a></span>
<span id="cb39-14"><a href=""></a>E_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(datos<span class="sc">$</span>altitud)</span>
<span id="cb39-15"><a href=""></a>E_sd <span class="ot">&lt;-</span> <span class="fu">sd</span>(datos<span class="sc">$</span>altitud)</span>
<span id="cb39-16"><a href=""></a></span>
<span id="cb39-17"><a href=""></a>H_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(datos<span class="sc">$</span>altura)</span>
<span id="cb39-18"><a href=""></a>H_sd <span class="ot">&lt;-</span> <span class="fu">sd</span>(datos<span class="sc">$</span>altura)</span>
<span id="cb39-19"><a href=""></a></span>
<span id="cb39-20"><a href=""></a>datos<span class="sc">$</span>D <span class="ot">&lt;-</span> (datos<span class="sc">$</span>danio <span class="sc">-</span> D_mean) <span class="sc">/</span> D_sd</span>
<span id="cb39-21"><a href=""></a>datos<span class="sc">$</span>E <span class="ot">&lt;-</span> (datos<span class="sc">$</span>altitud <span class="sc">-</span> E_mean) <span class="sc">/</span> E_sd</span>
<span id="cb39-22"><a href=""></a>datos<span class="sc">$</span>H <span class="ot">&lt;-</span> (datos<span class="sc">$</span>altura <span class="sc">-</span> H_mean) <span class="sc">/</span> H_sd</span>
<span id="cb39-23"><a href=""></a></span>
<span id="cb39-24"><a href=""></a><span class="co"># Datos para Stan</span></span>
<span id="cb39-25"><a href=""></a>stan_data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb39-26"><a href=""></a>  <span class="at">N =</span> <span class="fu">nrow</span>(datos),</span>
<span id="cb39-27"><a href=""></a>  <span class="at">y =</span> datos<span class="sc">$</span>germinadas,</span>
<span id="cb39-28"><a href=""></a>  <span class="at">S =</span> <span class="dv">120</span>,</span>
<span id="cb39-29"><a href=""></a>  </span>
<span id="cb39-30"><a href=""></a>  <span class="at">D =</span> datos<span class="sc">$</span>D,</span>
<span id="cb39-31"><a href=""></a>  <span class="at">E =</span> datos<span class="sc">$</span>E,</span>
<span id="cb39-32"><a href=""></a>  <span class="at">H =</span> datos<span class="sc">$</span>H</span>
<span id="cb39-33"><a href=""></a>)</span>
<span id="cb39-34"><a href=""></a></span>
<span id="cb39-35"><a href=""></a><span class="co"># Compilamos modelo</span></span>
<span id="cb39-36"><a href=""></a>model <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"modelos"</span>, <span class="st">"germinadas.stan"</span>))</span>
<span id="cb39-37"><a href=""></a></span>
<span id="cb39-38"><a href=""></a><span class="co"># Muestreamos</span></span>
<span id="cb39-39"><a href=""></a>fit <span class="ot">&lt;-</span> model<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> stan_data, <span class="at">parallel_chains =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 1 Iteration:  100 / 2000 [  5%]  (Warmup) 
Chain 1 Iteration:  200 / 2000 [ 10%]  (Warmup) 
Chain 1 Iteration:  300 / 2000 [ 15%]  (Warmup) 
Chain 1 Iteration:  400 / 2000 [ 20%]  (Warmup) 
Chain 1 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 1 Iteration:  600 / 2000 [ 30%]  (Warmup) 
Chain 1 Iteration:  700 / 2000 [ 35%]  (Warmup) 
Chain 1 Iteration:  800 / 2000 [ 40%]  (Warmup) 
Chain 1 Iteration:  900 / 2000 [ 45%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 1100 / 2000 [ 55%]  (Sampling) 
Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 2 Iteration:  100 / 2000 [  5%]  (Warmup) 
Chain 2 Iteration:  200 / 2000 [ 10%]  (Warmup) 
Chain 2 Iteration:  300 / 2000 [ 15%]  (Warmup) 
Chain 2 Iteration:  400 / 2000 [ 20%]  (Warmup) 
Chain 2 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 2 Iteration:  600 / 2000 [ 30%]  (Warmup) 
Chain 2 Iteration:  700 / 2000 [ 35%]  (Warmup) 
Chain 2 Iteration:  800 / 2000 [ 40%]  (Warmup) 
Chain 2 Iteration:  900 / 2000 [ 45%]  (Warmup) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 1100 / 2000 [ 55%]  (Sampling) 
Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 3 Iteration:  100 / 2000 [  5%]  (Warmup) 
Chain 3 Iteration:  200 / 2000 [ 10%]  (Warmup) 
Chain 3 Iteration:  300 / 2000 [ 15%]  (Warmup) 
Chain 3 Iteration:  400 / 2000 [ 20%]  (Warmup) 
Chain 3 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 3 Iteration:  600 / 2000 [ 30%]  (Warmup) 
Chain 3 Iteration:  700 / 2000 [ 35%]  (Warmup) 
Chain 3 Iteration:  800 / 2000 [ 40%]  (Warmup) 
Chain 3 Iteration:  900 / 2000 [ 45%]  (Warmup) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 1100 / 2000 [ 55%]  (Sampling) 
Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 4 Iteration:  100 / 2000 [  5%]  (Warmup) 
Chain 4 Iteration:  200 / 2000 [ 10%]  (Warmup) 
Chain 4 Iteration:  300 / 2000 [ 15%]  (Warmup) 
Chain 4 Iteration:  400 / 2000 [ 20%]  (Warmup) 
Chain 4 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 4 Iteration:  600 / 2000 [ 30%]  (Warmup) 
Chain 4 Iteration:  700 / 2000 [ 35%]  (Warmup) 
Chain 4 Iteration:  800 / 2000 [ 40%]  (Warmup) 
Chain 4 Iteration:  900 / 2000 [ 45%]  (Warmup) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 1100 / 2000 [ 55%]  (Sampling) 
Chain 1 Iteration: 1200 / 2000 [ 60%]  (Sampling) 
Chain 1 Iteration: 1300 / 2000 [ 65%]  (Sampling) 
Chain 1 Iteration: 1400 / 2000 [ 70%]  (Sampling) 
Chain 1 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 2 Iteration: 1200 / 2000 [ 60%]  (Sampling) 
Chain 2 Iteration: 1300 / 2000 [ 65%]  (Sampling) 
Chain 2 Iteration: 1400 / 2000 [ 70%]  (Sampling) 
Chain 3 Iteration: 1200 / 2000 [ 60%]  (Sampling) 
Chain 3 Iteration: 1300 / 2000 [ 65%]  (Sampling) 
Chain 3 Iteration: 1400 / 2000 [ 70%]  (Sampling) 
Chain 4 Iteration: 1200 / 2000 [ 60%]  (Sampling) 
Chain 4 Iteration: 1300 / 2000 [ 65%]  (Sampling) 
Chain 4 Iteration: 1400 / 2000 [ 70%]  (Sampling) 
Chain 1 Iteration: 1600 / 2000 [ 80%]  (Sampling) 
Chain 1 Iteration: 1700 / 2000 [ 85%]  (Sampling) 
Chain 1 Iteration: 1800 / 2000 [ 90%]  (Sampling) 
Chain 2 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 2 Iteration: 1600 / 2000 [ 80%]  (Sampling) 
Chain 2 Iteration: 1700 / 2000 [ 85%]  (Sampling) 
Chain 3 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 3 Iteration: 1600 / 2000 [ 80%]  (Sampling) 
Chain 3 Iteration: 1700 / 2000 [ 85%]  (Sampling) 
Chain 4 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 4 Iteration: 1600 / 2000 [ 80%]  (Sampling) 
Chain 4 Iteration: 1700 / 2000 [ 85%]  (Sampling) 
Chain 1 Iteration: 1900 / 2000 [ 95%]  (Sampling) 
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 Iteration: 1800 / 2000 [ 90%]  (Sampling) 
Chain 2 Iteration: 1900 / 2000 [ 95%]  (Sampling) 
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 Iteration: 1800 / 2000 [ 90%]  (Sampling) 
Chain 3 Iteration: 1900 / 2000 [ 95%]  (Sampling) 
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 Iteration: 1800 / 2000 [ 90%]  (Sampling) 
Chain 4 Iteration: 1900 / 2000 [ 95%]  (Sampling) 
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 0.4 seconds.
Chain 2 finished in 0.5 seconds.
Chain 3 finished in 0.4 seconds.
Chain 4 finished in 0.4 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.4 seconds.
Total execution time: 0.5 seconds.</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href=""></a><span class="co"># Chequeamos MCMC</span></span>
<span id="cb41-2"><a href=""></a>fit<span class="sc">$</span><span class="fu">cmdstan_diagnose</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Checking sampler transitions treedepth.
Treedepth satisfactory for all transitions.

Checking sampler transitions for divergences.
No divergent transitions found.

Checking E-BFMI - sampler transitions HMC potential energy.
E-BFMI satisfactory.

Rank-normalized split effective sample size satisfactory for all parameters.

Rank-normalized split R-hat values satisfactory for all parameters.

Processing complete, no problems detected.</code></pre>
</div>
</div>
</section>
<section class="slide level2">

<p>Verificación predictiva posterior</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href=""></a><span class="co"># Extraemos muestras de los parámetros que necesitamos</span></span>
<span id="cb43-2"><a href=""></a>d <span class="ot">&lt;-</span> fit<span class="sc">$</span><span class="fu">draws</span>(</span>
<span id="cb43-3"><a href=""></a>  <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"beta_D"</span>, <span class="st">"beta_E"</span>, <span class="st">"beta_H"</span>, <span class="st">"phi"</span>), <span class="at">format =</span> <span class="st">"draws_df"</span></span>
<span id="cb43-4"><a href=""></a>)</span>
<span id="cb43-5"><a href=""></a><span class="fu">colnames</span>(d) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"bD"</span>, <span class="st">"bE"</span>, <span class="st">"bH"</span>, <span class="st">"phi"</span>)</span>
<span id="cb43-6"><a href=""></a>S <span class="ot">&lt;-</span> <span class="fu">nrow</span>(d)</span>
<span id="cb43-7"><a href=""></a>N <span class="ot">&lt;-</span> <span class="fu">nrow</span>(datos)</span>
<span id="cb43-8"><a href=""></a></span>
<span id="cb43-9"><a href=""></a><span class="co"># Verificamos el ajuste simulando de la predictiva posterior. Para simular de </span></span>
<span id="cb43-10"><a href=""></a><span class="co"># la beta-binomial en R usaremos el paquete extraDistr, que incluye la función</span></span>
<span id="cb43-11"><a href=""></a><span class="co"># rbbinom</span></span>
<span id="cb43-12"><a href=""></a>ysim <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, N, S)</span>
<span id="cb43-13"><a href=""></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>S) {</span>
<span id="cb43-14"><a href=""></a>  mu <span class="ot">&lt;-</span> <span class="fu">plogis</span>( <span class="co"># equivale a inv_logit = logit inverso</span></span>
<span id="cb43-15"><a href=""></a>    d<span class="sc">$</span>a[i] <span class="sc">+</span> </span>
<span id="cb43-16"><a href=""></a>    d<span class="sc">$</span>bD[i] <span class="sc">*</span> datos<span class="sc">$</span>D <span class="sc">+</span> d<span class="sc">$</span>bE[i] <span class="sc">*</span> datos<span class="sc">$</span>E <span class="sc">+</span> d<span class="sc">$</span>bH[i] <span class="sc">*</span> datos<span class="sc">$</span>H </span>
<span id="cb43-17"><a href=""></a>  )</span>
<span id="cb43-18"><a href=""></a>  a <span class="ot">&lt;-</span> mu <span class="sc">*</span> d<span class="sc">$</span>phi[i]</span>
<span id="cb43-19"><a href=""></a>  b <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> mu) <span class="sc">*</span> d<span class="sc">$</span>phi[i]</span>
<span id="cb43-20"><a href=""></a>  ysim[, i] <span class="ot">&lt;-</span> <span class="fu">rbbinom</span>(N, datos<span class="sc">$</span>sembradas, a, b)</span>
<span id="cb43-21"><a href=""></a>} </span>
<span id="cb43-22"><a href=""></a></span>
<span id="cb43-23"><a href=""></a>ysim_t <span class="ot">&lt;-</span> <span class="fu">t</span>(ysim)</span>
<span id="cb43-24"><a href=""></a></span>
<span id="cb43-25"><a href=""></a><span class="co"># Miramos con bayesplot</span></span>
<span id="cb43-26"><a href=""></a><span class="fu">ppc_intervals</span>(</span>
<span id="cb43-27"><a href=""></a>  datos<span class="sc">$</span>germinadas, <span class="at">yrep =</span> ysim_t, <span class="at">x =</span> datos<span class="sc">$</span>danio,</span>
<span id="cb43-28"><a href=""></a>  <span class="at">prob =</span> <span class="fl">0.5</span>, <span class="at">prob_outer =</span> <span class="fl">0.9</span></span>
<span id="cb43-29"><a href=""></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-14-1.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href=""></a>use <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>S, <span class="dv">100</span>)</span>
<span id="cb44-2"><a href=""></a><span class="fu">ppc_dens_overlay</span>(datos<span class="sc">$</span>germinadas, <span class="at">yrep =</span> ysim_t[use, ])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-14-2.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href=""></a><span class="co"># DHARMa</span></span>
<span id="cb45-2"><a href=""></a>res <span class="ot">&lt;-</span> <span class="fu">createDHARMa</span>(ysim, datos<span class="sc">$</span>germinadas, <span class="at">integerResponse =</span> T)</span>
<span id="cb45-3"><a href=""></a><span class="fu">plot</span>(res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-14-3.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href=""></a><span class="fu">plotResiduals</span>(res, <span class="at">form =</span> datos<span class="sc">$</span>danio, <span class="at">rank =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-14-4.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href=""></a><span class="fu">plotResiduals</span>(res, <span class="at">form =</span> datos<span class="sc">$</span>altitud, <span class="at">rank =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-14-5.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href=""></a><span class="fu">plotResiduals</span>(res, <span class="at">form =</span> datos<span class="sc">$</span>altura, <span class="at">rank =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-14-6.png" width="480"></p>
</figure>
</div>
</div>
</div>
</section>
<section class="slide level2">

<p>Comparamos posterior vs.&nbsp;previa de <span class="math inline">\(\phi\)</span></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href=""></a><span class="co"># phi</span></span>
<span id="cb49-2"><a href=""></a><span class="fu">plot</span>(<span class="fu">density</span>(d<span class="sc">$</span>phi, <span class="at">from =</span> <span class="dv">0</span>), <span class="at">main =</span> <span class="cn">NA</span>, <span class="at">xlab =</span> <span class="fu">expression</span>(phi))</span>
<span id="cb49-3"><a href=""></a><span class="fu">curve</span>(<span class="fu">dlnorm</span>(x, <span class="fu">log</span>(<span class="dv">7</span>), <span class="fl">1.5</span>), <span class="at">add =</span> T, <span class="at">col =</span> <span class="dv">4</span>) <span class="co"># previa definida en Stan</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>

</div>
<img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-15-1.png" width="480" class="r-stretch"></section>
<section class="slide level2">

<p><span class="math inline">\(R^2\)</span></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href=""></a><span class="co"># Vector para almacenar el R2</span></span>
<span id="cb50-2"><a href=""></a>R2 <span class="ot">&lt;-</span> <span class="fu">numeric</span>(S)</span>
<span id="cb50-3"><a href=""></a></span>
<span id="cb50-4"><a href=""></a><span class="co"># Por comodidad, definimos las sembradas</span></span>
<span id="cb50-5"><a href=""></a>SS <span class="ot">&lt;-</span> datos<span class="sc">$</span>sembradas[<span class="dv">1</span>]</span>
<span id="cb50-6"><a href=""></a></span>
<span id="cb50-7"><a href=""></a><span class="co"># Loop sobre muestras de la posterior</span></span>
<span id="cb50-8"><a href=""></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>S) {</span>
<span id="cb50-9"><a href=""></a>  <span class="co"># En la beta-binomial, la media es mu * size,</span></span>
<span id="cb50-10"><a href=""></a>  <span class="co"># siendo size la cantidad de sembradas</span></span>
<span id="cb50-11"><a href=""></a>  </span>
<span id="cb50-12"><a href=""></a>  <span class="co"># predichos para cada observación</span></span>
<span id="cb50-13"><a href=""></a>  mu <span class="ot">&lt;-</span> <span class="fu">plogis</span>( <span class="co"># equivale a inv_logit = logit inverso</span></span>
<span id="cb50-14"><a href=""></a>    d<span class="sc">$</span>a[i] <span class="sc">+</span> </span>
<span id="cb50-15"><a href=""></a>    d<span class="sc">$</span>bD[i] <span class="sc">*</span> datos<span class="sc">$</span>D <span class="sc">+</span> d<span class="sc">$</span>bE[i] <span class="sc">*</span> datos<span class="sc">$</span>E <span class="sc">+</span> d<span class="sc">$</span>bH[i] <span class="sc">*</span> datos<span class="sc">$</span>H </span>
<span id="cb50-16"><a href=""></a>  )</span>
<span id="cb50-17"><a href=""></a>  media <span class="ot">&lt;-</span> mu <span class="sc">*</span> SS <span class="co"># 120 sembradas</span></span>
<span id="cb50-18"><a href=""></a>  </span>
<span id="cb50-19"><a href=""></a>  <span class="co"># varianza de los predichos = varianza explicada</span></span>
<span id="cb50-20"><a href=""></a>  var_fit <span class="ot">&lt;-</span> <span class="fu">var</span>(media)</span>
<span id="cb50-21"><a href=""></a>  </span>
<span id="cb50-22"><a href=""></a>  <span class="co"># varianza residual para cada observación. En la beta-binomial, la </span></span>
<span id="cb50-23"><a href=""></a>  <span class="co"># varianza se define así:</span></span>
<span id="cb50-24"><a href=""></a>  var_res <span class="ot">&lt;-</span> SS <span class="sc">*</span> mu <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> mu) <span class="sc">*</span> ((N <span class="sc">+</span> d<span class="sc">$</span>phi[i]) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> d<span class="sc">$</span>phi[i]))</span>
<span id="cb50-25"><a href=""></a>  </span>
<span id="cb50-26"><a href=""></a>  <span class="co"># y tomamos su media entre observaciones</span></span>
<span id="cb50-27"><a href=""></a>  var_res_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(var_res)</span>
<span id="cb50-28"><a href=""></a>  </span>
<span id="cb50-29"><a href=""></a>  <span class="co"># R2 </span></span>
<span id="cb50-30"><a href=""></a>  R2[i] <span class="ot">&lt;-</span> var_fit <span class="sc">/</span> (var_fit <span class="sc">+</span> var_res_mean)</span>
<span id="cb50-31"><a href=""></a>}</span>
<span id="cb50-32"><a href=""></a></span>
<span id="cb50-33"><a href=""></a><span class="fu">plot</span>(<span class="fu">density</span>(R2, <span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">1</span>), <span class="at">main =</span> <span class="cn">NA</span>, <span class="at">xlab =</span> <span class="st">"R2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>

</div>
<img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-16-1.png" width="480" class="r-stretch"></section>
<section class="slide level2">

<p>Visualizamos resultados de interés: predicciones parciales</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href=""></a><span class="co"># Predicción parcial para visualizar el efecto del daño por fuego (D).</span></span>
<span id="cb51-2"><a href=""></a></span>
<span id="cb51-3"><a href=""></a><span class="co"># Graficaremos curvas basadas en nrep valores de daño en el rango observado</span></span>
<span id="cb51-4"><a href=""></a>nrep <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb51-5"><a href=""></a>danio_seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(datos<span class="sc">$</span>danio), <span class="fu">max</span>(datos<span class="sc">$</span>danio), <span class="at">length.out =</span> nrep)</span>
<span id="cb51-6"><a href=""></a><span class="co"># Estandarizamos la secuencia, porque los parámetros viven en escala estandarizada.</span></span>
<span id="cb51-7"><a href=""></a>D_seq <span class="ot">&lt;-</span> (danio_seq <span class="sc">-</span> D_mean) <span class="sc">/</span> D_sd</span>
<span id="cb51-8"><a href=""></a></span>
<span id="cb51-9"><a href=""></a><span class="co"># Creamos data.frame de predicciones con las predictoras. Las predictoras no </span></span>
<span id="cb51-10"><a href=""></a><span class="co"># focales se fijan en su media (0 porque están estandarizadas), por eso es una </span></span>
<span id="cb51-11"><a href=""></a><span class="co"># predicción parcial.</span></span>
<span id="cb51-12"><a href=""></a>pred <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb51-13"><a href=""></a>  <span class="at">D =</span> D_seq, </span>
<span id="cb51-14"><a href=""></a>  <span class="at">E =</span> <span class="dv">0</span>,</span>
<span id="cb51-15"><a href=""></a>  <span class="at">H =</span> <span class="dv">0</span></span>
<span id="cb51-16"><a href=""></a>)</span>
<span id="cb51-17"><a href=""></a>pred<span class="sc">$</span>danio <span class="ot">&lt;-</span> danio_seq <span class="co"># la agregamos en la escala original, para visualizar</span></span>
<span id="cb51-18"><a href=""></a></span>
<span id="cb51-19"><a href=""></a><span class="co"># Matriz para llenar con predicciones de mu</span></span>
<span id="cb51-20"><a href=""></a>mu_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, nrep, S)</span>
<span id="cb51-21"><a href=""></a></span>
<span id="cb51-22"><a href=""></a><span class="co"># Y matriz para llenar con valores simulados de semillas germinadas</span></span>
<span id="cb51-23"><a href=""></a>y_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, nrep, S) <span class="co"># se parece a ysim, pero tiene nrep filas, no N.</span></span>
<span id="cb51-24"><a href=""></a></span>
<span id="cb51-25"><a href=""></a><span class="co"># Las llenamos</span></span>
<span id="cb51-26"><a href=""></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>S) {</span>
<span id="cb51-27"><a href=""></a>  mu <span class="ot">&lt;-</span> <span class="fu">plogis</span>( <span class="co"># equivale a inv_logit = logit inverso</span></span>
<span id="cb51-28"><a href=""></a>    d<span class="sc">$</span>a[i] <span class="sc">+</span> </span>
<span id="cb51-29"><a href=""></a>    d<span class="sc">$</span>bD[i] <span class="sc">*</span> pred<span class="sc">$</span>D <span class="sc">+</span> d<span class="sc">$</span>bE[i] <span class="sc">*</span> pred<span class="sc">$</span>E <span class="sc">+</span> d<span class="sc">$</span>bH[i] <span class="sc">*</span> pred<span class="sc">$</span>H </span>
<span id="cb51-30"><a href=""></a>    <span class="co"># los dos últimos términos pueden obviarse, pero los dejamos para </span></span>
<span id="cb51-31"><a href=""></a>    <span class="co"># explicitar.</span></span>
<span id="cb51-32"><a href=""></a>  )</span>
<span id="cb51-33"><a href=""></a>  mu_mat[, i] <span class="ot">&lt;-</span> mu</span>
<span id="cb51-34"><a href=""></a>  </span>
<span id="cb51-35"><a href=""></a>  <span class="co"># calculamos alpha y beta para simular</span></span>
<span id="cb51-36"><a href=""></a>  a <span class="ot">&lt;-</span> mu <span class="sc">*</span> d<span class="sc">$</span>phi[i]</span>
<span id="cb51-37"><a href=""></a>  b <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> mu) <span class="sc">*</span> d<span class="sc">$</span>phi[i]</span>
<span id="cb51-38"><a href=""></a>  y_mat[, i] <span class="ot">&lt;-</span> <span class="fu">rbbinom</span>(nrep, datos<span class="sc">$</span>sembradas[<span class="dv">1</span>], a, b)</span>
<span id="cb51-39"><a href=""></a>} </span>
<span id="cb51-40"><a href=""></a></span>
<span id="cb51-41"><a href=""></a><span class="co"># Resumimos la distribución posterior de mu fila por fila</span></span>
<span id="cb51-42"><a href=""></a>pred<span class="sc">$</span>mu_mean <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(mu_mat)</span>
<span id="cb51-43"><a href=""></a>pred<span class="sc">$</span>mu_lwr <span class="ot">&lt;-</span> <span class="fu">apply</span>(mu_mat, <span class="dv">1</span>, quantile, <span class="at">probs =</span> <span class="fl">0.025</span>)</span>
<span id="cb51-44"><a href=""></a>pred<span class="sc">$</span>mu_upr <span class="ot">&lt;-</span> <span class="fu">apply</span>(mu_mat, <span class="dv">1</span>, quantile, <span class="at">probs =</span> <span class="fl">0.975</span>)</span>
<span id="cb51-45"><a href=""></a></span>
<span id="cb51-46"><a href=""></a><span class="co"># Convertimos la distribución de y en proporciones, para que esté en la misma</span></span>
<span id="cb51-47"><a href=""></a><span class="co"># escala que mu</span></span>
<span id="cb51-48"><a href=""></a>y_mat_p <span class="ot">&lt;-</span> y_mat <span class="sc">/</span> datos<span class="sc">$</span>sembradas[<span class="dv">1</span>]</span>
<span id="cb51-49"><a href=""></a></span>
<span id="cb51-50"><a href=""></a><span class="co"># y resumimos</span></span>
<span id="cb51-51"><a href=""></a>pred<span class="sc">$</span>y_lwr <span class="ot">&lt;-</span> <span class="fu">apply</span>(y_mat_p, <span class="dv">1</span>, quantile, <span class="at">probs =</span> <span class="fl">0.025</span>)</span>
<span id="cb51-52"><a href=""></a>pred<span class="sc">$</span>y_upr <span class="ot">&lt;-</span> <span class="fu">apply</span>(y_mat_p, <span class="dv">1</span>, quantile, <span class="at">probs =</span> <span class="fl">0.975</span>)</span>
<span id="cb51-53"><a href=""></a></span>
<span id="cb51-54"><a href=""></a><span class="co"># Calculamos la proporción observada en los datos</span></span>
<span id="cb51-55"><a href=""></a>datos<span class="sc">$</span>prop <span class="ot">&lt;-</span> datos<span class="sc">$</span>germinadas <span class="sc">/</span> datos<span class="sc">$</span>sembradas</span>
<span id="cb51-56"><a href=""></a></span>
<span id="cb51-57"><a href=""></a><span class="co"># Graficamos </span></span>
<span id="cb51-58"><a href=""></a><span class="fu">ggplot</span>(pred, <span class="fu">aes</span>(danio, mu_mean, <span class="at">ymin =</span> mu_lwr, <span class="at">ymax =</span> mu_upr)) <span class="sc">+</span></span>
<span id="cb51-59"><a href=""></a>  <span class="co"># Intervalo de predicción (posterior predictive)</span></span>
<span id="cb51-60"><a href=""></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(danio, <span class="at">ymin =</span> y_lwr, <span class="at">ymax =</span> y_upr), <span class="at">inherit.aes =</span> F, </span>
<span id="cb51-61"><a href=""></a>              <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">fill =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb51-62"><a href=""></a>  <span class="co"># Intervalo para la media</span></span>
<span id="cb51-63"><a href=""></a>  <span class="fu">geom_ribbon</span>(<span class="at">color =</span> <span class="cn">NA</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">fill =</span> <span class="st">"orange"</span>) <span class="sc">+</span> </span>
<span id="cb51-64"><a href=""></a>  <span class="co"># Media de la media</span></span>
<span id="cb51-65"><a href=""></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb51-66"><a href=""></a>  <span class="co"># datos</span></span>
<span id="cb51-67"><a href=""></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(danio, prop), <span class="at">data =</span> datos, <span class="at">inherit.aes =</span> F,</span>
<span id="cb51-68"><a href=""></a>             <span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb51-69"><a href=""></a>  <span class="fu">labs</span>(</span>
<span id="cb51-70"><a href=""></a>    <span class="at">y =</span> <span class="st">"Proporción de germinación"</span>,</span>
<span id="cb51-71"><a href=""></a>    <span class="at">x =</span> <span class="st">"Daño (%)"</span></span>
<span id="cb51-72"><a href=""></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>

</div>
<img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-17-1.png" width="480" class="r-stretch"></section>
<section class="slide level2">

<p>En esta predicción se fijaron en su media las demás predictoras. Esto hace que la predicción no sea comparable con los datos, ya que en los datos, las predictoras sí varían. En este caso, los datos no discrepan de la predicción porque las otras predictoras tienen efectos muy pequeños.</p>
<p><br></p>
<p>Para realizar otras predicciones hay que ponerse creativo al crear la tabla con nuevos valores para las predictoras. Por ejemplo, podríamos graficar más de una curva, para 3 valores contrastantes de alguna otra predictora. Esto es útil para visualizar interacciones.</p>
</section>
<section id="simulaciones-previas" class="slide level2">
<h2>Simulaciones previas</h2>
<p><br></p>
<p>Al definir las previas de un modelo con ajuste bayesiano necesitamos inicialmente posicionarnos en relación a qué efecto deseamos de las previas. Algunas opciones pueden ser:</p>
<ul>
<li class="fragment"><p>reflejar conocimiento previo sobre el sistema,</p></li>
<li class="fragment"><p>restringir levemente los parámetros para que tomen valores razonables,</p></li>
<li class="fragment"><p>restringir fuertemente los parámetros para que el modelo sea estimable,</p></li>
<li class="fragment"><p>influir lo menos posible en el resultado, limitándose a garantizar la convergencia de algoritmos de estimación.</p></li>
</ul>
</section>
<section class="slide level2">

<p>Independientemente de la postura, para definir previas necesitamos poder traducir información de formas variadas a una distribución de probabilidad. Salvo que contemos con una intuición algebraica y probabilística envidiable, necesitamos graficar las implicancias de las previas en los modelos. Claramente, en contextos donde no hay información previa abundante, conviene investigar un poco qué tipo de previas se recomiendan para el tipo de modelo en cuestión. Para muchas estructuras hay recomendaciones disponibles.</p>
<p><br></p>
<p>En última instancia, si la definición de previas nos quita el sueño, podemos ajustar el modelo con distintas previas y comparar resultados. Esto incluso puede plantearse como un problema de comparación de modelos: cambiar la previa es equivalente a cambiar el modelo.</p>
</section>
<section class="slide level2">

<p>Para mostrar estrategias para definir previas utilizaremos los modelos ajustados arriba para el número de incendios y la cantidad de semillas germinadas. Supondremos que no hay mucha información previa y que deseamos distribuciones previas con poco efecto en el ajuste, de tal forma que la posterior esté dominada por la verosimilitud.</p>
</section>
<section class="slide level2">

<h3 id="simulaciones-previas-1-incendios">Simulaciones previas 1: incendios</h3>
<p><br></p>
<p>El modelo estaba definido de la siguiente manera:</p>
<p><br></p>
<p><span class="math display">\[
\begin{aligned}
y_i &amp;\sim \text{poisson}(\lambda_i) \\
\lambda_i &amp;= \text{exp}(\alpha + \beta \  FWI_i) \\
\\
\alpha &amp;\sim \text{normal}(\mu_{\alpha}, \sigma_{\alpha}) \\
\beta &amp;\sim \text{normal}(\mu_{\beta}, \sigma_{\beta}) \\
\\
\mu_{\alpha} &amp;= \ ..., \sigma_{\alpha} = \ ... \\
\mu_{\beta} &amp;= \ ..., \sigma_{\beta} = \ ...
\end{aligned}
\]</span></p>
</section>
<section class="slide level2">

<p>Si deseamos previas que generen valores razonables de <span class="math inline">\(\lambda\)</span> sin afectar mucho el resultado, estamos buscando <em>previas levemente regularizadoras</em>.</p>
<p>Un buen primer paso es intentar interpretar los parámetros del modelo. Si eso es muy difícil, conviene graficar.</p>
<p>Consideremos que <span class="math inline">\(\alpha = \log(\lambda)\)</span> cuando <span class="math inline">\(FWI = 0\)</span>. De esta manera, <span class="math display">\[\lambda_{FWI=0} \sim \text{log-normal}(\mu_{\alpha}, \sigma_{\alpha}).\]</span> Entonces, graficamos la lognormal variando sus parámetros (expresados en escala log).</p>
</section>
<section class="slide level2">

<p>Para graficar previas o sus implicancias rápidamente, resulta de gran utilidad la función <code>curve</code>, que evalúa una expresión conteniendo “x”.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href=""></a>mu_a <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="dv">10</span>) <span class="co"># la mediana de la lognormal sería 10</span></span>
<span id="cb52-2"><a href=""></a>sigma_a <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb52-3"><a href=""></a><span class="fu">curve</span>(<span class="fu">dlnorm</span>(x, mu_a, sigma_a), <span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>

</div>
<img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-18-1.png" width="480" class="r-stretch"><p>Con <span class="math inline">\(\sigma_{\alpha} = 2\)</span> la distribución se hace muy amplia. No nos dejemos engañar por su pico cerca de cero. Si bien en esa zona la densidad es alta, la masa de probabilidad (área bajo la curva) es baja, por lo que esta previa no sesgaría la estimación hacia cero si hay al menos unos pocos datos.</p>
</section>
<section class="slide level2">

<p>Pero si nos interesa no sesgar el resultado, otra estrategia es centrar la previa en la media de los datos, y darle un desvío grande:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href=""></a><span class="co"># Cargamos datos</span></span>
<span id="cb53-2"><a href=""></a>datos <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"datos"</span>, <span class="st">"barbera_data_fire_total_climate.csv"</span>))</span>
<span id="cb53-3"><a href=""></a></span>
<span id="cb53-4"><a href=""></a>mu_a <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="fu">mean</span>(datos<span class="sc">$</span>fires)) </span>
<span id="cb53-5"><a href=""></a>sigma_a <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb53-6"><a href=""></a><span class="fu">curve</span>(<span class="fu">dlnorm</span>(x, mu_a, sigma_a), <span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>

</div>
<img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-19-1.png" width="480" class="r-stretch"><p>Si queremos informar aún menos, podemos aumentar un poco más $_{}.</p>
</section>
<section class="slide level2">

<p>Ahora nos centramos en <span class="math inline">\(\beta\)</span>. Por suerte, para este modelo (GLM con enlace log), <span class="math inline">\(\beta\)</span> tiene una interpretación clara: <span class="math inline">\(\exp(\beta)\)</span> es el factor en que aumenta <span class="math inline">\(\lambda\)</span> cuando <span class="math inline">\(x = FWI\)</span> aumenta una unidad. Si suponemos que <span class="math inline">\(\lambda\)</span> se duplica al aumentar el <span class="math inline">\(FWI\)</span> una unidad, <span class="math inline">\(\beta = \log(2)\)</span>. Pero como el <span class="math inline">\(FWI\)</span> varía entre 0 y ~50, ese aumento sería absurdamente grande. Quizás es más sensato pensar en aumentos más pequeños. Probemos un aumento de 1.1 <span class="math inline">\(\beta = \log(1.1)\)</span>.</p>
<p>Nuevamente, <span class="math inline">\(\exp(\beta)\)</span> sigue una distribución log-normal:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href=""></a>mu_b <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="fl">1.1</span>)</span>
<span id="cb54-2"><a href=""></a>sigma_b <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb54-3"><a href=""></a><span class="fu">curve</span>(<span class="fu">dlnorm</span>(x, mu_b, sigma_b), <span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-20-1.png" width="480"></p>
</figure>
</div>
</div>
</div>
<p>Esta previa tiene mediana y media positiva (1.1), pero también permite valores menores a 1, que implican disminución del número de incendios con el <span class="math inline">\(FWI\)</span>. Si esto no nos parece razonable, podemos modificar la previa para dejar poca probabilidad abajo de 1 (restricción blanda) o truncar la previa en 1, para que sólo permita aumentos. Iremos por el primer enfoque.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href=""></a>mu_b <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="fl">1.1</span>)</span>
<span id="cb55-2"><a href=""></a>sigma_b <span class="ot">&lt;-</span> <span class="fl">0.05</span></span>
<span id="cb55-3"><a href=""></a><span class="fu">curve</span>(<span class="fu">dlnorm</span>(x, mu_b, sigma_b), <span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-21-1.png" width="480"></p>
</figure>
</div>
</div>
</div>
<p>Ahora es una previa más razonable, quizás algo informativa. Pero cuán informativa es dependerá de cuán informativos sean los datos.</p>
<p>Ahora graficamos las previas elegidas para <span class="math inline">\(\alpha\)</span> y <span class="math inline">\(\beta\)</span> (escala log, son normales):</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href=""></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb56-2"><a href=""></a><span class="fu">curve</span>(<span class="fu">dnorm</span>(x, mu_a, sigma_a), <span class="at">from =</span> <span class="sc">-</span><span class="dv">10</span>, <span class="at">to =</span> <span class="dv">15</span>, <span class="at">xlab =</span> <span class="fu">expression</span>(alpha),</span>
<span id="cb56-3"><a href=""></a>      <span class="at">ylab =</span> <span class="st">"Densidad"</span>)</span>
<span id="cb56-4"><a href=""></a><span class="fu">curve</span>(<span class="fu">dnorm</span>(x, mu_b, sigma_b), <span class="at">from =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">to =</span> <span class="dv">1</span>, <span class="at">xlab =</span> <span class="fu">expression</span>(beta),</span>
<span id="cb56-5"><a href=""></a>      <span class="at">ylab =</span> <span class="cn">NA</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-22-1.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href=""></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section class="slide level2">

<p>Ahora podemos simular valores de estas previas para explorar qué curvas de <span class="math inline">\(\lambda = f(FWI)\)</span> implican:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href=""></a>light_col <span class="ot">&lt;-</span> <span class="fu">rgb</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="fl">0.1</span>)</span>
<span id="cb58-2"><a href=""></a></span>
<span id="cb58-3"><a href=""></a><span class="co"># gráfico inicial</span></span>
<span id="cb58-4"><a href=""></a>a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, mu_a, sigma_a)</span>
<span id="cb58-5"><a href=""></a>b <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, mu_b, sigma_b)</span>
<span id="cb58-6"><a href=""></a><span class="fu">curve</span>(<span class="fu">exp</span>(a <span class="sc">+</span> b <span class="sc">*</span> x), <span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">20</span>, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">100</span>), <span class="at">col =</span> light_col,</span>
<span id="cb58-7"><a href=""></a>      <span class="at">xlab =</span> <span class="st">"FWI"</span>, <span class="at">ylab =</span> <span class="fu">expression</span>(lambda)) </span>
<span id="cb58-8"><a href=""></a></span>
<span id="cb58-9"><a href=""></a><span class="co"># Repetimos con muchas muestras, usando el argumento "add = TRUE" en curve()</span></span>
<span id="cb58-10"><a href=""></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">200</span>) {</span>
<span id="cb58-11"><a href=""></a>  a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, mu_a, sigma_a)</span>
<span id="cb58-12"><a href=""></a>  b <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, mu_b, sigma_b)</span>
<span id="cb58-13"><a href=""></a>  <span class="fu">curve</span>(<span class="fu">exp</span>(a <span class="sc">+</span> b <span class="sc">*</span> x), <span class="at">col =</span> light_col, <span class="at">add =</span> T)</span>
<span id="cb58-14"><a href=""></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>

</div>
<img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-23-1.png" width="480" class="r-stretch"><p>Muchas curvas parecen poco razonables. Pero bueno, estábamos buscando previas poco informativas, ¿no?</p>
</section>
<section class="slide level2">

<p>También podemos simular datos utilizando los valores observados de la predictora. Esto implica simular de la distribución predictiva previa (análoga a la distribución predictiva posterior).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href=""></a>N <span class="ot">&lt;-</span> <span class="fu">nrow</span>(datos)</span>
<span id="cb59-2"><a href=""></a>S <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb59-3"><a href=""></a>ysim <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, N, S)</span>
<span id="cb59-4"><a href=""></a></span>
<span id="cb59-5"><a href=""></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>S) {</span>
<span id="cb59-6"><a href=""></a>  a <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, mu_a, sigma_a)</span>
<span id="cb59-7"><a href=""></a>  b <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, mu_b, sigma_b)</span>
<span id="cb59-8"><a href=""></a>  lambda <span class="ot">&lt;-</span> <span class="fu">exp</span>(a <span class="sc">+</span> b <span class="sc">*</span> datos<span class="sc">$</span>fwi)</span>
<span id="cb59-9"><a href=""></a>  ysim[, i] <span class="ot">&lt;-</span> <span class="fu">rpois</span>(N, lambda)</span>
<span id="cb59-10"><a href=""></a>}</span>
<span id="cb59-11"><a href=""></a></span>
<span id="cb59-12"><a href=""></a><span class="fu">hist</span>(<span class="fu">as.numeric</span>(ysim))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>

<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href=""></a><span class="fu">quantile</span>(<span class="fu">as.numeric</span>(ysim), <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.9</span>, <span class="fl">0.95</span>, <span class="fl">0.98</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>    90%     95%     98% 
 521.00 1138.00 2648.02 </code></pre>
</div>
</div>
<img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-24-1.png" width="480" class="r-stretch"><p>Los datos simulados pueden tomar valores muy altos. Esto puede ser razonable si no queremos que la previa influya mucho en los resultados.</p>
</section>
<section class="slide level2">

<p>Para ilustrar un ejemplo de previa poco intuitiva, alteraremos el modelo: en vez de suponer una distribución poisson, supondremos binomial negativa, que admite mayor dispersión mediante el parámetro <span class="math inline">\(phi\)</span>:</p>
<p><span class="math display">\[
\begin{aligned}
y_i &amp;\sim \text{binomial negativa}(\lambda_i, \phi) \\
\lambda_i &amp;= \text{exp}(\alpha + \beta \  FWI_i) \\
\\
\alpha &amp;\sim \text{normal}(\mu_{\alpha}, \sigma_{\alpha}) \\
\beta &amp;\sim \text{normal}(\mu_{\beta}, \sigma_{\beta}) \\
\phi &amp;\sim \text{gama}(a = 1 / \tau, b = 1 / (\mu_{\phi} \ \tau)) \\
\\
\mu_{\alpha} &amp;= \ ..., \sigma_{\alpha} = \ ... \\
\mu_{\beta} &amp;= \ ..., \sigma_{\beta} = \ ... \\
\mu_{\phi} &amp;= \ ..., \tau = \ ...
\end{aligned}
\]</span></p>
</section>
<section class="slide level2">

<p>La varianza de la binomial negativa, con media <span class="math inline">\(\lambda\)</span> se define como</p>
<p><span class="math display">\[\mathrm{Var}(Y) = \lambda + \frac{\lambda^2}{\phi},\]</span></p>
<p>equivalente a</p>
<p><span class="math display">\[\mathrm{Var}(Y) = \lambda \left(1 + \frac{\lambda}{\phi} \right).\]</span></p>
<p>Por lo que <span class="math inline">\(\phi\)</span> tiene una relación inversa con la varianza, y se puede decir que es un parámetro de precisión (opuesto a dispersión).</p>
</section>
<section class="slide level2">

<p>Podemos evaluar las implicancias de <span class="math inline">\(\phi\)</span> fijando <span class="math inline">\(\lambda\)</span> y visualizando la pmf.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href=""></a><span class="co"># usamos dnbinom de extraDistr, que la parametriza igual que Stan's neg_binomial_2.</span></span>
<span id="cb62-2"><a href=""></a><span class="co"># size = phi</span></span>
<span id="cb62-3"><a href=""></a>x <span class="ot">&lt;-</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">100</span></span>
<span id="cb62-4"><a href=""></a></span>
<span id="cb62-5"><a href=""></a>y <span class="ot">&lt;-</span> <span class="fu">dnbinom</span>(x, <span class="at">mu =</span> <span class="dv">10</span>, <span class="at">size =</span> <span class="dv">1000</span>)</span>
<span id="cb62-6"><a href=""></a><span class="fu">barplot</span>(y <span class="sc">~</span> x); <span class="fu">abline</span>(<span class="at">v =</span> <span class="dv">10</span>, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="fl">1.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-25-1.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href=""></a><span class="co"># Con size alto tiende a poisson</span></span>
<span id="cb63-2"><a href=""></a></span>
<span id="cb63-3"><a href=""></a>y <span class="ot">&lt;-</span> <span class="fu">dnbinom</span>(x, <span class="at">mu =</span> <span class="dv">10</span>, <span class="at">size =</span> <span class="dv">1</span>)</span>
<span id="cb63-4"><a href=""></a><span class="fu">barplot</span>(y <span class="sc">~</span> x); <span class="fu">abline</span>(<span class="at">v =</span> <span class="dv">10</span>, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="fl">1.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-25-2.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href=""></a>y <span class="ot">&lt;-</span> <span class="fu">dnbinom</span>(x, <span class="at">mu =</span> <span class="dv">10</span>, <span class="at">size =</span> <span class="fl">0.1</span>)</span>
<span id="cb64-2"><a href=""></a><span class="fu">barplot</span>(y <span class="sc">~</span> x); <span class="fu">abline</span>(<span class="at">v =</span> <span class="dv">10</span>, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="fl">1.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-25-3.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href=""></a><span class="co"># ChatGPT recomendó una previa gama(2, 0.1), lo que implica</span></span>
<span id="cb65-2"><a href=""></a><span class="co"># a = 2 = 1 / 0.5</span></span>
<span id="cb65-3"><a href=""></a><span class="co"># b = 0.1 = 1 / (0.5 * 20) </span></span>
<span id="cb65-4"><a href=""></a><span class="co"># lo que implica mu_phi = 20, tau = 0.5</span></span>
<span id="cb65-5"><a href=""></a></span>
<span id="cb65-6"><a href=""></a>lambda <span class="ot">&lt;-</span> <span class="dv">20</span> <span class="co"># probar cambiarlo</span></span>
<span id="cb65-7"><a href=""></a>mu_phi <span class="ot">&lt;-</span> <span class="dv">20</span> <span class="co"># nos gustan?</span></span>
<span id="cb65-8"><a href=""></a>tau <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb65-9"><a href=""></a></span>
<span id="cb65-10"><a href=""></a>phi <span class="ot">&lt;-</span> <span class="fu">rgamma</span>(<span class="dv">1</span>, <span class="dv">1</span> <span class="sc">/</span> tau, <span class="dv">1</span> <span class="sc">/</span> (mu_phi <span class="sc">*</span> tau))</span>
<span id="cb65-11"><a href=""></a><span class="fu">curve</span>(</span>
<span id="cb65-12"><a href=""></a>  <span class="fu">dnbinom</span>(x, <span class="at">size =</span> phi, <span class="at">mu =</span> <span class="dv">10</span>), <span class="co"># este mu es lambda</span></span>
<span id="cb65-13"><a href=""></a>  <span class="at">to =</span> lambda <span class="sc">*</span> <span class="dv">10</span>, <span class="at">col =</span> light_col, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>)</span>
<span id="cb65-14"><a href=""></a>) </span>
<span id="cb65-15"><a href=""></a></span>
<span id="cb65-16"><a href=""></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">200</span>) {</span>
<span id="cb65-17"><a href=""></a>  phi <span class="ot">&lt;-</span> <span class="fu">rgamma</span>(<span class="dv">1</span>, <span class="dv">1</span> <span class="sc">/</span> tau, <span class="dv">1</span> <span class="sc">/</span> (mu_phi <span class="sc">*</span> tau))</span>
<span id="cb65-18"><a href=""></a>  <span class="fu">curve</span>(<span class="fu">dnbinom</span>(x, <span class="at">size =</span> phi, <span class="at">mu =</span> <span class="dv">10</span>), <span class="at">add =</span> T, <span class="at">col =</span> light_col) <span class="co"># este mu es lambda</span></span>
<span id="cb65-19"><a href=""></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-25-4.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href=""></a><span class="co"># Para ser menos informativo, prefiero mu_phi = 20, tau = 1 (tau es la dispersión</span></span>
<span id="cb66-2"><a href=""></a><span class="co"># de la gama, por lo que mi previa es más amplia que la recomendada por ChatGPT)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section class="slide level2">

<h3 id="simulaciones-previas-2-germinación">Simulaciones previas 2: germinación</h3>
<p><br></p>
<p>Retomemos el modelo de semillas germinadas de Alinari et al.&nbsp;2024:</p>
<p><span class="math display">\[
\begin{aligned}
y_i &amp;\sim \text{beta-binomial}(\mu_i, \phi, S_i) \\
\mu_i &amp;= \frac{1}{1 + \exp(-\eta_i)} \\
\eta_i &amp;= \alpha + \beta_D \ D_i + \beta_E \ E_i + \beta_H \ H_i\\
\\
\alpha &amp;\sim \text{normal}(0, 10) \\
\beta_. &amp;\sim \text{normal}(0, 5) \\
\phi &amp;\sim \text{log-normal}(\log(10), 2) \\
\\
\text{y: } &amp;\text{Número de semillas germinadas} \\
\text{N: } &amp;\text{Número de semillas sembradas} \\
\text{D: } &amp;\text{Daño por fuego} \\
\text{E: } &amp;\text{Altidud} \\
\text{H: } &amp;\text{Altura inicial del árbol} \\
\end{aligned}
\]</span></p>
</section>
<section class="slide level2">

<p>Comencemos explorando previas para el intercepto (<span class="math inline">\(\alpha\)</span>). Recordemos que</p>
<p><span class="math display">\[
\begin{aligned}
\text{logit}^{-1}(x) &amp;= \frac{1}{1 + \exp(-x)} \\
\text{logit}^{-1}(0) &amp;= 0.5 \\
\text{logit}^{-1}(5) &amp;= 0.9933071 \\
\text{logit}^{-1}(-5) &amp;= 1 - 0.9933071 \\
\text{logit}^{-1}(+\infty) &amp;\approx 1 \\
\text{logit}^{-1}(-\infty) &amp;\approx 0 \\
\end{aligned}
\]</span></p>
</section>
<section class="slide level2">

<p>Con predictoras estandarizadas (media = 0), <span class="math inline">\(\alpha\)</span> es la probabilidad de germinación (<span class="math inline">\(\mu\)</span>) cuando las predictoras están en sus medias.</p>
<p>Si <span class="math inline">\(\alpha \sim \text{normal}()\)</span>, entonces <span class="math inline">\(\text{logit}^{-1}(\alpha) \sim \text{logit-normal}()\)</span>.</p>
<p>Si la media de la previa de <span class="math inline">\(\alpha\)</span> es 0, a medida que aumentamos su desvío acumulamos masa cerca de <span class="math inline">\(\mu = 0\)</span> y <span class="math inline">\(\mu = 1\)</span>:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href=""></a><span class="co"># usamos el paquete logitnorm para la distribución logit-normal</span></span>
<span id="cb67-2"><a href=""></a></span>
<span id="cb67-3"><a href=""></a>mu_a <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb67-4"><a href=""></a>sigma_a <span class="ot">&lt;-</span> <span class="fl">1.4</span></span>
<span id="cb67-5"><a href=""></a><span class="fu">curve</span>(<span class="fu">dlogitnorm</span>(x, mu_a, sigma_a))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-26-1.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href=""></a>sigma_a <span class="ot">&lt;-</span> <span class="fl">1.8</span></span>
<span id="cb68-2"><a href=""></a><span class="fu">curve</span>(<span class="fu">dlogitnorm</span>(x, mu_a, sigma_a))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-26-2.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href=""></a>sigma_a <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb69-2"><a href=""></a><span class="fu">curve</span>(<span class="fu">dlogitnorm</span>(x, mu_a, sigma_a))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-26-3.png" width="480"></p>
</figure>
</div>
</div>
</div>
<p>Si bien puede resultar poco intuitivo, la previa con sd = 10 resulta muy poco informativa. Permite que se estimen probabiliades extremas si los datos lo indican.</p>
</section>
<section class="slide level2">

<p>Yendo a los <span class="math inline">\(\beta\)</span>, una gran ventaja de estandarizar las predictoras es que sus previas pueden ser todas iguales, a falta de información que sugiera que lo sean.</p>
<p>Para explorar previas sobre <span class="math inline">\(\beta\)</span> conviene asumir el efecto parcial de una predictora, fijando las demás en sus medias y <span class="math inline">\(\alpha = 0\)</span>.</p>
<p>Como seremos indiferentes al signo, las previas de <span class="math inline">\(\beta\)</span> estarán centradas en 0.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href=""></a>sigma_b <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb70-2"><a href=""></a></span>
<span id="cb70-3"><a href=""></a>b <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, sigma_b)</span>
<span id="cb70-4"><a href=""></a></span>
<span id="cb70-5"><a href=""></a><span class="co"># plogis es inv_logit en R.</span></span>
<span id="cb70-6"><a href=""></a><span class="co"># de -3 a 3 porque ese rango suele ocupar una variable estandarizada</span></span>
<span id="cb70-7"><a href=""></a><span class="co"># cuando es aproximadamente normal.</span></span>
<span id="cb70-8"><a href=""></a><span class="fu">curve</span>(<span class="fu">plogis</span>(b <span class="sc">*</span> x), <span class="at">from =</span> <span class="sc">-</span><span class="dv">3</span>, <span class="at">to =</span> <span class="dv">3</span>, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb70-9"><a href=""></a>      <span class="at">col =</span> light_col)</span>
<span id="cb70-10"><a href=""></a></span>
<span id="cb70-11"><a href=""></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">200</span>) {</span>
<span id="cb70-12"><a href=""></a>  b <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, sigma_b)</span>
<span id="cb70-13"><a href=""></a>  <span class="fu">curve</span>(<span class="fu">plogis</span>(b <span class="sc">*</span> x), <span class="at">col =</span> light_col, <span class="at">add =</span> T)</span>
<span id="cb70-14"><a href=""></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-27-1.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href=""></a><span class="co"># sigma mayor</span></span>
<span id="cb71-2"><a href=""></a>sigma_b <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb71-3"><a href=""></a>b <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, sigma_b)</span>
<span id="cb71-4"><a href=""></a><span class="fu">curve</span>(<span class="fu">plogis</span>(b <span class="sc">*</span> x), <span class="at">from =</span> <span class="sc">-</span><span class="dv">3</span>, <span class="at">to =</span> <span class="dv">3</span>, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb71-5"><a href=""></a>      <span class="at">col =</span> light_col)</span>
<span id="cb71-6"><a href=""></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">200</span>) {</span>
<span id="cb71-7"><a href=""></a>  b <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, sigma_b)</span>
<span id="cb71-8"><a href=""></a>  <span class="fu">curve</span>(<span class="fu">plogis</span>(b <span class="sc">*</span> x), <span class="at">col =</span> light_col, <span class="at">add =</span> T)</span>
<span id="cb71-9"><a href=""></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-27-2.png" width="480"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href=""></a><span class="co"># y mayor</span></span>
<span id="cb72-2"><a href=""></a>sigma_b <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb72-3"><a href=""></a>b <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, sigma_b)</span>
<span id="cb72-4"><a href=""></a><span class="fu">curve</span>(<span class="fu">plogis</span>(b <span class="sc">*</span> x), <span class="at">from =</span> <span class="sc">-</span><span class="dv">3</span>, <span class="at">to =</span> <span class="dv">3</span>, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb72-5"><a href=""></a>      <span class="at">col =</span> light_col)</span>
<span id="cb72-6"><a href=""></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">200</span>) {</span>
<span id="cb72-7"><a href=""></a>  b <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, sigma_b)</span>
<span id="cb72-8"><a href=""></a>  <span class="fu">curve</span>(<span class="fu">plogis</span>(b <span class="sc">*</span> x), <span class="at">col =</span> light_col, <span class="at">add =</span> T)</span>
<span id="cb72-9"><a href=""></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure>
<p><img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-27-3.png" width="480"></p>
</figure>
</div>
</div>
</div>
<p>Igual que con <span class="math inline">\(\alpha\)</span>, una previa amplia para <span class="math inline">\(\beta\)</span> no sesga la posterior hacia valores extremos; simplemente no impide que los datos lo sugieran. No es conveniente si tenemos escasos datos.</p>
</section>
<section class="slide level2">

<p>Por último, debemos definir la previa para <span class="math inline">\(\phi\)</span>, el parámetro de precisión de la distribución beta-binomial. La beta-binomial es una binomial con mayor dispersión (regulada por <span class="math inline">\(\phi\)</span>), que surge de suponer que la probabilidad de éxito (<span class="math inline">\(\pi\)</span>, aquí <span class="math inline">\(\mu\)</span>) de una binomial sigue una distribución beta. Su varianza es</p>
<p><span class="math display">\[\mathrm{Var}(Y) = N \mu (1 - \mu) \left( \frac{N + \phi}{1 + \phi} \right),\]</span></p>
<p>donde <span class="math inline">\(N\)</span> es el número de experimentos, <span class="math inline">\(\phi\)</span> es un parámetro de precisión (<span class="math inline">\(\alpha + \beta\)</span> en la distribución beta) y <span class="math inline">\(\mu\)</span> es la probabilidad de éxito. (La media es <span class="math inline">\(\mu \times N\)</span>.)</p>
<p>Graficaremos la pmf suponiendo <span class="math inline">\(N = 500\)</span> y <span class="math inline">\(\mu = 0.5\)</span>.</p>
</section>
<section class="slide level2">

<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href=""></a><span class="co"># usamos extraDistr</span></span>
<span id="cb73-2"><a href=""></a></span>
<span id="cb73-3"><a href=""></a><span class="co"># dbetabinom, se parametriza con alpha y beta, no con mu y phi.</span></span>
<span id="cb73-4"><a href=""></a><span class="co"># Se definen así:</span></span>
<span id="cb73-5"><a href=""></a>mu <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb73-6"><a href=""></a>N <span class="ot">&lt;-</span> <span class="dv">500</span>  <span class="co"># N</span></span>
<span id="cb73-7"><a href=""></a></span>
<span id="cb73-8"><a href=""></a></span>
<span id="cb73-9"><a href=""></a>phi <span class="ot">&lt;-</span> <span class="fu">rlnorm</span>(<span class="dv">1</span>, <span class="fu">log</span>(<span class="dv">10</span>), <span class="dv">2</span>)</span>
<span id="cb73-10"><a href=""></a>alpha <span class="ot">&lt;-</span> mu <span class="sc">*</span> phi      <span class="co"># necesarios para dbbinom</span></span>
<span id="cb73-11"><a href=""></a>beta <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> mu) <span class="sc">*</span> phi</span>
<span id="cb73-12"><a href=""></a><span class="fu">curve</span>(</span>
<span id="cb73-13"><a href=""></a>  <span class="fu">dbbinom</span>(x, <span class="at">size =</span> N, <span class="at">alpha =</span> alpha, <span class="at">beta =</span> beta),</span>
<span id="cb73-14"><a href=""></a>  <span class="at">to =</span> N, <span class="at">col =</span> light_col, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>)</span>
<span id="cb73-15"><a href=""></a>) </span>
<span id="cb73-16"><a href=""></a></span>
<span id="cb73-17"><a href=""></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">200</span>) {</span>
<span id="cb73-18"><a href=""></a>  phi <span class="ot">&lt;-</span> <span class="fu">rlnorm</span>(<span class="dv">1</span>, <span class="fu">log</span>(<span class="dv">10</span>), <span class="dv">2</span>)</span>
<span id="cb73-19"><a href=""></a>  alpha <span class="ot">&lt;-</span> mu <span class="sc">*</span> phi   </span>
<span id="cb73-20"><a href=""></a>  beta <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> mu) <span class="sc">*</span> phi</span>
<span id="cb73-21"><a href=""></a>  <span class="fu">curve</span>(<span class="fu">dbbinom</span>(x, <span class="at">size =</span> N, <span class="at">alpha =</span> alpha, <span class="at">beta =</span> beta),</span>
<span id="cb73-22"><a href=""></a>        <span class="at">col =</span> light_col, <span class="at">add =</span> T)</span>
<span id="cb73-23"><a href=""></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>

</div>
<img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-28-1.png" width="480" class="r-stretch"><p>La previa definida es muy amplia; permite muchas distribuciones en que los valores se acumulan en los extremos (todos éxitos o todos fracasos). Podemos encogerla.</p>
</section>
<section class="slide level2">

<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href=""></a><span class="co"># usamos sd = 1.5 en vez de 2 en la previa lognormal de phi</span></span>
<span id="cb74-2"><a href=""></a></span>
<span id="cb74-3"><a href=""></a>phi <span class="ot">&lt;-</span> <span class="fu">rlnorm</span>(<span class="dv">1</span>, <span class="fu">log</span>(<span class="dv">10</span>), <span class="fl">1.5</span>)</span>
<span id="cb74-4"><a href=""></a>alpha <span class="ot">&lt;-</span> mu <span class="sc">*</span> phi      <span class="co"># necesarios para dbbinom</span></span>
<span id="cb74-5"><a href=""></a>beta <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> mu) <span class="sc">*</span> phi</span>
<span id="cb74-6"><a href=""></a><span class="fu">curve</span>(</span>
<span id="cb74-7"><a href=""></a>  <span class="fu">dbbinom</span>(x, <span class="at">size =</span> N, <span class="at">alpha =</span> alpha, <span class="at">beta =</span> beta),</span>
<span id="cb74-8"><a href=""></a>  <span class="at">to =</span> N, <span class="at">col =</span> light_col, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.1</span>)</span>
<span id="cb74-9"><a href=""></a>) </span>
<span id="cb74-10"><a href=""></a></span>
<span id="cb74-11"><a href=""></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">200</span>) {</span>
<span id="cb74-12"><a href=""></a>  phi <span class="ot">&lt;-</span> <span class="fu">rlnorm</span>(<span class="dv">1</span>, <span class="fu">log</span>(<span class="dv">10</span>), <span class="dv">1</span>)</span>
<span id="cb74-13"><a href=""></a>  alpha <span class="ot">&lt;-</span> mu <span class="sc">*</span> phi   </span>
<span id="cb74-14"><a href=""></a>  beta <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> mu) <span class="sc">*</span> phi</span>
<span id="cb74-15"><a href=""></a>  <span class="fu">curve</span>(<span class="fu">dbbinom</span>(x, <span class="at">size =</span> N, <span class="at">alpha =</span> alpha, <span class="at">beta =</span> beta),</span>
<span id="cb74-16"><a href=""></a>        <span class="at">col =</span> light_col, <span class="at">add =</span> T)</span>
<span id="cb74-17"><a href=""></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>

</div>
<img data-src="Clase7_verificacion-interpretacion_files/figure-revealjs/unnamed-chunk-29-1.png" width="480" class="r-stretch"><p>Esta es un poco menos extrema.</p>

</section>
    </div>
  <div class="quarto-auto-generated-content" style="display: none;">
<div class="footer footer-default">

</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="Clase7_verificacion-interpretacion_files/libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="Clase7_verificacion-interpretacion_files/libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="Clase7_verificacion-interpretacion_files/libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="Clase7_verificacion-interpretacion_files/libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="Clase7_verificacion-interpretacion_files/libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="Clase7_verificacion-interpretacion_files/libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="Clase7_verificacion-interpretacion_files/libs/revealjs/plugin/notes/notes.js"></script>
  <script src="Clase7_verificacion-interpretacion_files/libs/revealjs/plugin/search/search.js"></script>
  <script src="Clase7_verificacion-interpretacion_files/libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="Clase7_verificacion-interpretacion_files/libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'slide',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    
    <script>
      // htmlwidgets need to know to resize themselves when slides are shown/hidden.
      // Fire the "slideenter" event (handled by htmlwidgets.js) when the current
      // slide changes (different for each slide format).
      (function () {
        // dispatch for htmlwidgets
        function fireSlideEnter() {
          const event = window.document.createEvent("Event");
          event.initEvent("slideenter", true, true);
          window.document.dispatchEvent(event);
        }

        function fireSlideChanged(previousSlide, currentSlide) {
          fireSlideEnter();

          // dispatch for shiny
          if (window.jQuery) {
            if (previousSlide) {
              window.jQuery(previousSlide).trigger("hidden");
            }
            if (currentSlide) {
              window.jQuery(currentSlide).trigger("shown");
            }
          }
        }

        // hookup for slidy
        if (window.w3c_slidy) {
          window.w3c_slidy.add_observer(function (slide_num) {
            // slide_num starts at position 1
            fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);
          });
        }

      })();
    </script>

    <script id="quarto-html-after-body" type="application/javascript">
    window.document.addEventListener("DOMContentLoaded", function (event) {
      const toggleBodyColorMode = (bsSheetEl) => {
        const mode = bsSheetEl.getAttribute("data-mode");
        const bodyEl = window.document.querySelector("body");
        if (mode === "dark") {
          bodyEl.classList.add("quarto-dark");
          bodyEl.classList.remove("quarto-light");
        } else {
          bodyEl.classList.add("quarto-light");
          bodyEl.classList.remove("quarto-dark");
        }
      }
      const toggleBodyColorPrimary = () => {
        const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
        if (bsSheetEl) {
          toggleBodyColorMode(bsSheetEl);
        }
      }
      toggleBodyColorPrimary();  
      const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
      tabsets.forEach(function(tabset) {
        const tabby = new Tabby('#' + tabset.id);
      });
      const isCodeAnnotation = (el) => {
        for (const clz of el.classList) {
          if (clz.startsWith('code-annotation-')) {                     
            return true;
          }
        }
        return false;
      }
      const onCopySuccess = function(e) {
        // button target
        const button = e.trigger;
        // don't keep focus
        button.blur();
        // flash "checked"
        button.classList.add('code-copy-button-checked');
        var currentTitle = button.getAttribute("title");
        button.setAttribute("title", "Copied!");
        let tooltip;
        if (window.bootstrap) {
          button.setAttribute("data-bs-toggle", "tooltip");
          button.setAttribute("data-bs-placement", "left");
          button.setAttribute("data-bs-title", "Copied!");
          tooltip = new bootstrap.Tooltip(button, 
            { trigger: "manual", 
              customClass: "code-copy-button-tooltip",
              offset: [0, -8]});
          tooltip.show();    
        }
        setTimeout(function() {
          if (tooltip) {
            tooltip.hide();
            button.removeAttribute("data-bs-title");
            button.removeAttribute("data-bs-toggle");
            button.removeAttribute("data-bs-placement");
          }
          button.setAttribute("title", currentTitle);
          button.classList.remove('code-copy-button-checked');
        }, 1000);
        // clear code selection
        e.clearSelection();
      }
      const getTextToCopy = function(trigger) {
          const codeEl = trigger.previousElementSibling.cloneNode(true);
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
      }
      const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
        text: getTextToCopy
      });
      clipboard.on('success', onCopySuccess);
      if (window.document.getElementById('quarto-embedded-source-code-modal')) {
        const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
          text: getTextToCopy,
          container: window.document.getElementById('quarto-embedded-source-code-modal')
        });
        clipboardModal.on('success', onCopySuccess);
      }
        var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
        var mailtoRegex = new RegExp(/^mailto:/);
          var filterRegex = new RegExp('/' + window.location.host + '/');
        var isInternal = (href) => {
            return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
        }
        // Inspect non-navigation links and adorn them if external
     	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
        for (var i=0; i<links.length; i++) {
          const link = links[i];
          if (!isInternal(link.href)) {
            // undo the damage that might have been done by quarto-nav.js in the case of
            // links that we want to consider external
            if (link.dataset.originalHref !== undefined) {
              link.href = link.dataset.originalHref;
            }
          }
        }
      function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
        const config = {
          allowHTML: true,
          maxWidth: 500,
          delay: 100,
          arrow: false,
          appendTo: function(el) {
              return el.closest('section.slide') || el.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start',
        };
        if (contentFn) {
          config.content = contentFn;
        }
        if (onTriggerFn) {
          config.onTrigger = onTriggerFn;
        }
        if (onUntriggerFn) {
          config.onUntrigger = onUntriggerFn;
        }
          config['offset'] = [0,0];
          config['maxWidth'] = 700;
        window.tippy(el, config); 
      }
      const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
      for (var i=0; i<noterefs.length; i++) {
        const ref = noterefs[i];
        tippyHover(ref, function() {
          // use id or data attribute instead here
          let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
          try { href = new URL(href).hash; } catch {}
          const id = href.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note) {
            return note.innerHTML;
          } else {
            return "";
          }
        });
      }
      const findCites = (el) => {
        const parentEl = el.parentElement;
        if (parentEl) {
          const cites = parentEl.dataset.cites;
          if (cites) {
            return {
              el,
              cites: cites.split(' ')
            };
          } else {
            return findCites(el.parentElement)
          }
        } else {
          return undefined;
        }
      };
      var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
      for (var i=0; i<bibliorefs.length; i++) {
        const ref = bibliorefs[i];
        const citeInfo = findCites(ref);
        if (citeInfo) {
          tippyHover(citeInfo.el, function() {
            var popup = window.document.createElement('div');
            citeInfo.cites.forEach(function(cite) {
              var citeDiv = window.document.createElement('div');
              citeDiv.classList.add('hanging-indent');
              citeDiv.classList.add('csl-entry');
              var biblioDiv = window.document.getElementById('ref-' + cite);
              if (biblioDiv) {
                citeDiv.innerHTML = biblioDiv.innerHTML;
              }
              popup.appendChild(citeDiv);
            });
            return popup.innerHTML;
          });
        }
      }
    });
    </script>
    

</body></html>